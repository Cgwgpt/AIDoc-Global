
<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AIDoc Global</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      /* 移动端极致适配与美化 */
      @media (max-width: 600px) {
        .layout {
          grid-template-columns: 1fr;
          height: auto;
        }
        .side {
          display: block;
        }
        .main {
          padding: 0;
        }
        .toolbar {
          flex-direction: row;
          gap: 0;
          padding: 8px 4px 8px 8px;
          min-height: 48px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }
        .toolbar .brand {
          font-size: 18px;
          font-weight: 700;
          display: flex;
          align-items: center;
          gap: 6px;
        }
        .iconbtn {
          width: 36px;
          height: 36px;
          font-size: 18px;
          border-radius: 10px;
        }
        .chat {
          width: 100vw !important;
          min-width: 0 !important;
          max-width: 100vw !important;
          height: 60vh !important;
          max-height: 400px !important;
          min-height: 200px !important;
          padding: 8px 2vw 8px 2vw !important;
          border-radius: 12px !important;
          box-shadow: 0 2px 12px rgba(0,0,0,0.06);
          margin: 12px 0 0 0 !important;
        }
        .composer {
          position: sticky;
          left: 0; right: 0; bottom: 0;
          background: var(--card);
          box-shadow: 0 -2px 12px rgba(0,0,0,0.06);
          border-radius: 16px 16px 0 0;
          padding: 8px 2vw 8px 2vw;
          z-index: 10;
        }
        .inputbar {
          gap: 4px;
        }
        .inputbar .iconbtn {
          width: 32px;
          height: 32px;
          font-size: 16px;
        }
        #prompt {
          font-size: 15px;
          padding: 8px 10px;
          border-radius: 8px;
        }
        .circle#send {
          width: 38px;
          height: 38px;
          font-size: 20px;
        }
        
        /* 移动端输入框内图片区域适配 */
        .input-content {
          min-height: 20px;
        }
        
        .input-images {
          padding: 6px 0 3px 0;
          margin-bottom: 3px;
        }
        
        .input-gallery {
          gap: 6px;
          max-height: 60px;
          flex-wrap: nowrap;
          overflow-x: auto;
          overflow-y: hidden;
        }
        
        .input-gallery .thumb {
          width: 32px;
          height: 32px;
          border-radius: 6px;
        }
        
        .input-gallery .thumb .rm {
          width: 14px;
          height: 14px;
          font-size: 9px;
          top: -3px;
          right: -3px;
        }
        
        .inputbar textarea {
          font-size: 14px;
          min-height: 20px;
        }
        .empty, .panel, .gallery, .drop {
          border-radius: 10px !important;
        }
        .message, .message.bot, .message.user {
          border-radius: 10px !important;
          font-size: 15px !important;
          padding: 10px 12px !important;
        }
      }
      :root{
  /* AIDoc Global 主题色彩系统 */
        --primary-50: #f0f9ff;
        --primary-100: #e0f2fe;
        --primary-200: #bae6fd;
        --primary-500: #06b6d4;
        --primary-600: #0891b2;
        --primary-700: #0e7490;
        --primary-900: #164e63;
        
        /* 医疗辅助色 */
        --success-50: #f0fdf4;
        --success-500: #22c55e;
        --success-600: #16a34a;
        --warning-50: #fefce8;
        --warning-500: #eab308;
        --error-50: #fef2f2;
        --error-500: #ef4444;
        
        /* 中性色系 */
        --gray-50: #f8fafc;
        --gray-100: #f1f5f9;
        --gray-200: #e2e8f0;
        --gray-300: #cbd5e1;
        --gray-400: #94a3b8;
        --gray-500: #64748b;
        --gray-600: #475569;
        --gray-700: #334155;
        --gray-800: #1e293b;
        --gray-900: #0f172a;
        
        /* 语义化变量 */
        --bg: var(--gray-50);
        --bg-gradient: linear-gradient(135deg, var(--primary-50) 0%, var(--gray-50) 100%);
        --card: #ffffff;
        --card-elevated: #ffffff;
        --text: var(--gray-900);
        --text-secondary: var(--gray-600);
        --text-muted: var(--gray-500);
        --border: var(--gray-200);
        --border-light: var(--gray-100);
        --brand: var(--primary-600);
        --brand-light: var(--primary-100);
        --brand-hover: var(--primary-700);
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      }
      
      :root.dark{
        --bg: var(--gray-900);
        --bg-gradient: linear-gradient(135deg, #0c1222 0%, var(--gray-900) 100%);
        --card: var(--gray-800);
        --card-elevated: var(--gray-700);
        --text: var(--gray-100);
        --text-secondary: var(--gray-300);
        --text-muted: var(--gray-400);
        --border: var(--gray-700);
        --border-light: var(--gray-600);
        --brand: var(--primary-500);
        --brand-light: var(--primary-900);
        --brand-hover: var(--primary-400);
      }
      
      /* 全局重置和基础样式 */
      *, *::before, *::after {
        box-sizing: border-box;
      }
      
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      
      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: var(--bg-gradient);
        color: var(--text);
        line-height: 1.6;
        font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      

      /* 布局系统 */
      .layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        height: 100vh;
        gap: 0;
      }

      /* iPad Pro 12.9" 和 iPad Air 横屏优化 */
      @media (min-width: 1024px) and (max-width: 1366px) and (orientation: landscape) {
        .layout {
          grid-template-columns: 320px 1fr;
          height: 100vh;
        }
        
        .chat {
          height: calc(100vh - 120px);
          max-height: none;
          padding: 24px 32px;
        }
        
        .composer {
          padding: 20px 32px;
        }
        
        .inputbar {
          padding: 16px 20px;
        }
        
        .input-gallery .thumb {
          width: 48px;
          height: 48px;
        }
        
        .inputbar textarea {
          font-size: 16px;
        }
      }
      
      /* iPad Air 竖屏优化 */
      @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
        .layout {
          grid-template-columns: 1fr;
          height: auto;
        }
        
        .chat {
          height: calc(100vh - 160px);
          max-height: none;
          padding: 20px 24px;
        }
        
        .composer {
          padding: 16px 24px;
        }
        
        .inputbar {
          padding: 14px 18px;
        }
        
        .input-gallery .thumb {
          width: 44px;
          height: 44px;
        }
        
        .inputbar textarea {
          font-size: 15px;
        }
      }
      
      /* iPad Pro 11" 横屏优化 */
      @media (min-width: 834px) and (max-width: 1194px) and (orientation: landscape) {
        .layout {
          grid-template-columns: 300px 1fr;
          height: 100vh;
        }
        
        .chat {
          height: calc(100vh - 120px);
          max-height: none;
          padding: 20px 28px;
        }
        
        .composer {
          padding: 18px 28px;
        }
        
        .inputbar {
          padding: 15px 18px;
        }
        
        .input-gallery .thumb {
          width: 46px;
          height: 46px;
        }
        
        .inputbar textarea {
          font-size: 15px;
        }
      }

      @media (max-width: 1024px) {
        .layout {
          grid-template-columns: 1fr;
          height: auto;
        }
        .side {
          position: static;
          width: 100vw;
          max-width: 100vw;
          border-right: none;
          border-bottom: 1px solid var(--border);
          box-shadow: none;
          padding: 12px 8px;
        }
        .main {
          padding: 0 0 60px 0;
        }
      }

      @media (max-width: 900px) {
        .chat {
          width: 100% !important;
          min-width: 0 !important;
          max-width: 100vw !important;
          padding: 16px 4vw 16px 4vw !important;
          border-radius: 12px !important;
        }
      }

      @media (max-width: 600px) {
        .chat {
          height: calc(100vh - 140px) !important; /* 约= 顶部工具栏 + 底部输入区与间距 */
          max-height: none !important;
          min-height: 200px !important;
          padding: 8px 2vw 8px 2vw !important;
          border-radius: 8px !important;
        }
        .main {
          padding: 0 0 env(safe-area-inset-bottom, 0px);
        }
        .toolbar {
          flex-direction: row;
          flex-wrap: nowrap;
          align-items: center;
          justify-content: space-between;
          gap: 4px;
          padding: 10px 6px;
        }
        .toolbar .brand {
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
          max-width: 72vw;
          font-weight: 700;
          display: flex;
          align-items: center;
          gap: 4px;
        }
        .toolbar > div:first-child { min-width: 0; gap: 6px !important; flex: 1; }
        .toolbar > div:last-child { gap: 4px !important; }
      }

      /* 固定对话窗口大小 */
      .chat-window, .messages, .message-list {
        width: 600px;
        max-width: 100%;
        height: 480px;
        max-height: 60vh;
        min-height: 320px;
        overflow-y: auto;
        margin: 0 auto;
        background: var(--card);
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        padding: 24px 18px 18px 18px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      
      .side {
        background: var(--card);
        border-right: 1px solid var(--border);
        padding: 24px;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
        position: relative;
      }
      
      .side::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, var(--primary-500), var(--primary-200));
      }
      /* 侧边栏分组间距优化，减少底部留白 */
      .side { padding-bottom: 16px; }
      .side .group { margin-bottom: 12px; }
      .side .group:last-child { margin-bottom: 0; }

      /* 左侧栏方块+科技动感卡片风格 */

      .side .group {
        background: linear-gradient(180deg, rgba(255,255,255,0.66), rgba(255,255,255,0.46));
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px 12px;
        box-shadow: 0 6px 18px rgba(16, 24, 40, 0.06);
        margin-bottom: 16px;
        position: relative;
        transition: box-shadow 0.2s, transform 0.2s;
      }
      .side .group:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 24px rgba(16,24,40,0.10);
      }
      .main-title {
        font-size: 24px;
        color: var(--text);
      }
      .side #model { display: block; width: 100%; height: 40px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); }
      /* 网格化子内容，方块观感 */
      .side .group > div[style*="display:grid"],
      .side .group .grid {
        display: grid !important;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      /* 左侧栏按钮升级为方块按钮 */
      .side .btn.block {
        border-radius: 12px;
        padding: 14px 12px;
        backdrop-filter: blur(6px);
      }
      .side .btn.ghost.block {
        background: linear-gradient(180deg, rgba(255,255,255,0.35), rgba(255,255,255,0.15));
        border-color: rgba(148,163,184,0.45);
      }
      .side .btn.block::before {
        background: linear-gradient(90deg, rgba(99,102,241,.35), rgba(56,189,248,.35));
      }
      
      /* 顶部工具栏 */
      .toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 32px;
        background: var(--card);
        border-bottom: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        backdrop-filter: blur(12px);
        position: relative;
      }
      
      /* 桌面端品牌标题样式 */
      .brand {
        font-size: 24px;
        font-weight: 800;
        color: var(--text);
        display: flex;
        align-items: center;
        gap: 10px;
        letter-spacing: 0.5px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      
      window.saveUserEdit = async function(userId) {
        const name = document.getElementById('editUserName').value.trim();
        const email = document.getElementById('editUserEmail').value.trim();
        const phone = document.getElementById('editUserPhone').value.trim();
        const organization = document.getElementById('editUserOrg').value.trim();
        const status = document.getElementById('editUserStatus').value;
        const isAdmin = document.getElementById('editUserAdmin').value === 'true';
        const originalEmail = document.getElementById('editUserEmail').getAttribute('data-original-email') || email;
        if (!name) return showWarning('请输入用户姓名');
        if (!email) return showWarning('请输入邮箱地址');
        if (!isValidEmail(email)) return showWarning('请输入有效的邮箱地址');
        const tok = (adminTokenInput?.value || '').trim();
        if (!tok) return showWarning('请先填写管理员令牌');
        const updateData = {
          name,
          phone: phone || null,
          organization: organization || null,
          status,
          is_admin: isAdmin
        };
        if (email !== originalEmail) updateData.email = email;
        const apiUrl = `/api/admin/users/${userId}`;
        try {
          const response = await fetch(apiUrl, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': tok
            },
            body: JSON.stringify(updateData)
          });
          let data = null;
          // 优先尝试解析为json
          try {
            data = await response.json();
          } catch {
            // 不是json，尝试获取文本
            const text = await response.text();
            if (!response.ok) {
              showError('更新失败', `服务器错误 ${response.status}: ${text}`);
              return;
            }
            showError('更新失败', `未知错误: ${text}`);
            return;
          }
          if (!response.ok) {
            showError('更新失败', data?.detail || `服务器错误 ${response.status}`);
            return;
          }
          showSuccess('用户信息更新成功！', `用户 ${name} 的信息已更新`);
          // 关闭弹窗
          const modal = document.querySelector('.modal:last-of-type');
          if (modal) {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
          }
          // 刷新用户列表
          const refreshBtn = document.querySelector('[onclick*="refreshBtn"]');
          if (refreshBtn) refreshBtn.click();
        } catch (e) {
          showError('更新异常', e.toString());
        }
      }
      .meter {
        height: 12px;
        background: var(--gray-100);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
      }
      
      .meter > span {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, var(--success-500), var(--success-600));
        border-radius: 8px;
        transition: width 0.3s ease;
        position: relative;
      }
      
      .meter > span::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        animation: shimmer 2s infinite;
      }
      
      @keyframes shimmer {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
      }
      
      .row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: var(--text-muted);
        margin-top: 8px;
      }
      
      .checks {
        display: grid;
        gap: 12px;
      }
      
      .checks label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        cursor: pointer;
        transition: color 0.2s ease;
      }
      
      .checks label:hover {
        color: var(--text);
      }
      
      input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--brand);
      }
      
      /* 按钮系统 */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 20px;
        border: none;
        border-radius: 12px;
        font-size: 14px;
        font-weight: 500;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        outline: none;
        position: relative;
        overflow: hidden;
      }
      
      .btn:before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
      }
      
      .btn:hover:before {
        left: 100%;
      }
      
      .btn {
        background: var(--brand);
        color: white;
        box-shadow: var(--shadow);
      }
      
      .btn:hover {
        background: var(--brand-hover);
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }
      
      .btn:active {
        transform: translateY(0);
        box-shadow: var(--shadow-sm);
      }
      
      .btn.ghost {
        background: transparent;
        color: var(--text);
        border: 1px solid var(--border);
        box-shadow: none;
      }
      
      .btn.ghost:hover {
        background: var(--gray-50);
        border-color: var(--text-muted);
      }
      
      .btn.block {
        width: 100%;
      }
      
      .hint {
        font-size: 13px;
        color: var(--text-muted);
        line-height: 1.4;
      }

      /* 聊天区域 */
      .chat {
        flex: 1;
        overflow-y: auto;
        padding: 32px;
        background: var(--bg);
        position: relative;
      }
      
      .empty {
        height: 100%;
        border: 2px dashed var(--border);
        border-radius: 24px;
        background: var(--card);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 20px;
        color: var(--text-muted);
        position: relative;
        overflow: hidden;
      }
      
      .empty::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, var(--primary-50) 0%, transparent 70%);
        opacity: 0.5;
        animation: float 6s ease-in-out infinite;
      }
      
      @keyframes float {
        0%, 100% { transform: translate(0, 0) rotate(0deg); }
        50% { transform: translate(-20px, -20px) rotate(180deg); }
      }
      
      .empty > * {
        position: relative;
        z-index: 1;
      }
      
      .drop {
        padding: 24px;
        text-align: center;
        background: var(--primary-50);
        border-radius: 16px;
        border: 1px dashed var(--primary-200);
        margin: 20px 0;
        transition: all 0.3s ease;
      }
      
      .drop:hover {
        background: var(--primary-100);
        border-color: var(--primary-300);
        transform: scale(1.02);
      }
      
      .gallery {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        margin-top: 20px;
        padding: 16px;
        background: var(--card);
        border-radius: 16px;
        border: 1px solid var(--border-light);
      }
      .thumb {
        position: relative;
        width: 120px;
        height: 120px;
        border: 2px solid var(--border-light);
        border-radius: 16px;
        overflow: hidden;
        background: var(--gray-50);
        transition: all 0.2s ease;
        cursor: pointer;
      }
      
      .thumb:hover {
        border-color: var(--brand);
        box-shadow: var(--shadow-md);
        transform: scale(1.05);
      }
      
      .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.2s ease;
      }
      
      .thumb:hover img {
        transform: scale(1.1);
      }
      
      .thumb .rm {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--error-500);
        color: white;
        border: 2px solid white;
        display: grid;
        place-items: center;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: var(--shadow);
      }
      
      .thumb .rm:hover {
        background: #dc2626;
        transform: scale(1.1);
      }

      /* 消息气泡 */
      .message {
        max-width: 75%;
        padding: 8px 12px;
        border-radius: 20px;
        margin: 4px 0;
        position: relative;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
        line-height: 1.2;
        display: flex;
        align-items: flex-start;
        gap: 8px;
      }
      
      /* 消息图标 */
      .message-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
        margin-top: 2px;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
      }
      
      /* 消息内容容器 */
      .message-content {
        flex: 1;
        min-width: 0;
      }
      .message:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }
      
      .user {
        background: linear-gradient(135deg, var(--brand), var(--brand-hover));
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 8px;
        flex-direction: row-reverse;
      }
      
      /* 用户图标 */
      .user .message-icon {
        background: linear-gradient(135deg, #ffffff, #f8fafc);
        color: var(--brand);
        border: 2px solid rgba(255, 255, 255, 0.3);
        order: -1;
      }
      
      .user .message-icon:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-md);
      }
      
      .user::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: -8px;
        width: 0;
        height: 0;
        border-left: 8px solid var(--brand-hover);
        border-bottom: 8px solid transparent;
      }
      
      .bot {
        background: var(--card);
        border: 1px solid var(--border-light);
        color: var(--text);
        border-bottom-left-radius: 8px;
        position: relative;
      }
      
      /* 助手图标 */
      .bot .message-icon {
        background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        color: white;
        border: 2px solid var(--primary-100);
      }
      
      .bot .message-icon:hover {
        transform: scale(1.05);
        box-shadow: var(--shadow-md);
        background: linear-gradient(135deg, var(--primary-600), var(--primary-700));
      }
      
      .bot::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: -8px;
        width: 0;
        height: 0;
        border-right: 8px solid var(--card);
        border-bottom: 8px solid transparent;
      }
      
      .bot::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: -9px;
        width: 0;
        height: 0;
        border-right: 9px solid var(--border-light);
        border-bottom: 9px solid transparent;
      }
      
      .bubble-images {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 16px;
      }
      
      .bubble-images img {
        width: 160px;
        height: 160px;
        object-fit: cover;
        border-radius: 16px;
        border: 2px solid var(--border-light);
        background: var(--gray-50);
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .bubble-images img:hover {
        border-color: var(--brand);
        transform: scale(1.05);
        box-shadow: var(--shadow-md);
      }
      
      .mono {
        white-space: pre-wrap;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      }
      /* Markdown 样式优化 */
      .md {
        font-size: 15px;
        line-height: 1.2;
        word-break: break-word;
        overflow-wrap: anywhere;
        color: var(--text);
      }
      
      .md h1, .md h2, .md h3, .md h4, .md h5, .md h6 {
        font-weight: 600;
        color: var(--text);
        margin: 6px 0 2px 0;
        line-height: 1.0;
      }
      
      .md h1 { font-size: 24px; }
      .md h2 { font-size: 20px; }
      .md h3 { font-size: 18px; }
      .md h4 { font-size: 16px; }
      
      .md p {
        margin: 1px 0;
        line-height: 1.2;
      }
      
      .md ul, .md ol {
        margin: 2px 0;
        padding-left: 20px;
      }
      
      .md li {
        margin: 0;
        line-height: 1.2;
      }
      
      .md pre {
        background: var(--gray-900);
        color: var(--gray-100);
        padding: 16px 20px;
        border-radius: 12px;
        overflow: auto;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
        font-size: 14px;
        line-height: 1.5;
        margin: 16px 0;
        box-shadow: var(--shadow);
      }
      
      .md code {
        background: var(--gray-100);
        color: var(--gray-800);
        padding: 4px 8px;
        border-radius: 6px;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
        font-size: 13px;
      }
      
      .md a {
        color: var(--brand);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
      }
      .md a:hover {
        color: var(--brand-hover);
        text-decoration: underline;
      }
      
      .md blockquote {
        margin: 2px 0;
        padding: 6px 10px;
        border-left: 4px solid var(--brand);
        background: var(--primary-50);
        color: var(--text-secondary);
        border-radius: 0 12px 12px 0;
        font-style: italic;
        position: relative;
      }
      
      .md blockquote::before {
        content: '"';
        position: absolute;
        top: 8px;
        left: 12px;
        font-size: 24px;
        color: var(--brand);
        font-weight: bold;
      }
      
      .md hr {
        border: none;
        height: 2px;
        background: linear-gradient(90deg, transparent, var(--border), transparent);
        margin: 32px 0;
      }
      
      .md table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      
      .md th, .md td {
        border: 1px solid var(--border);
        padding: 12px 16px;
        font-size: 14px;
        text-align: left;
      }
      
      .md th {
        background: var(--gray-100);
        font-weight: 600;
        color: var(--text);
      }
      
      .md td {
        background: var(--card);
      }
      
      .md tr:hover td {
        background: var(--gray-50);
      }
      
      .md img {
        max-width: 100%;
        height: auto;
        display: block;
        margin: 20px auto;
        border-radius: 12px;
        box-shadow: var(--shadow);
        transition: transform 0.2s ease;
      }
      
      .md img:hover {
        transform: scale(1.02);
        box-shadow: var(--shadow-md);
      }
      .md li p {
        margin: 0;
      }
      
      .md > *:first-child {
        margin-top: 0 !important;
      }
      
      .md > *:last-child {
        margin-bottom: 0 !important;
      }
      
      /* 超紧凑显示优化 - 实现诊疗历史级别的紧凑度 */
      .md * + * {
        margin-top: 1px !important;
        margin-bottom: 0 !important;
      }
      
      .md h1 + *, .md h2 + *, .md h3 + *, .md h4 + *, .md h5 + *, .md h6 + * {
        margin-top: 2px !important;
      }
      
      .md ul li, .md ol li {
        padding: 0 !important;
        margin: 0 !important;
        line-height: 1.1 !important;
      }
      
      .md ul, .md ol {
        padding-left: 18px !important;
        margin: 1px 0 !important;
      }
      
      .md p, .md div {
        margin: 0 !important;
        padding: 0 !important;
      }
      
      /* 强制最小间距 */
      .md > * {
        margin-top: 1px !important;
        margin-bottom: 1px !important;
      }
      
      /* 针对数字列表的特殊优化 */
      .md ol > li {
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1.1 !important;
      }
      
      .md ol > li::marker {
        font-weight: 600;
      }
      
      /* 嵌套列表优化 */
      .md li > ul, .md li > ol {
        margin: 0 !important;
        padding-left: 16px !important;
      }
      
      .cursor {
        display: inline-block;
        width: 3px;
        height: 18px;
        background: var(--brand);
        margin-left: 4px;
        border-radius: 2px;
        animation: blink 1.2s ease-in-out infinite;
      }
      
      @keyframes blink {
        0%, 50% { opacity: 1; }
        51%, 100% { opacity: 0; }
      }

      /* 输入区域 */
      .composer {
        padding: 24px 32px;
        background: var(--card);
        border-top: 1px solid var(--border);
        box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.05);
        position: relative;
      }
      
      .composer::before {
        content: '';
        position: absolute;
        top: 0;
        left: 32px;
        right: 32px;
        height: 1px;
        background: linear-gradient(90deg, transparent, var(--primary-200), transparent);
      }
      
      .inputbar {
        display: flex;
        align-items: flex-end;
        gap: 12px;
        border: 2px solid var(--border);
        border-radius: 20px;
        padding: 12px 16px;
        background: var(--card);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }
      
      .inputbar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, var(--primary-50), transparent);
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      
      .inputbar:focus-within {
        border-color: var(--brand);
        box-shadow: 0 0 0 4px var(--brand-light);
      }
      
      .inputbar:focus-within::before {
        opacity: 1;
      }
      
      .input-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 24px;
        position: relative;
      }
      
      .input-images {
        padding: 8px 0 4px 0;
        border-bottom: 1px solid var(--border-light);
        margin-bottom: 4px;
      }
      
      .input-gallery {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        max-height: 80px;
        overflow-y: auto;
        overflow-x: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--border) transparent;
      }
      
      .input-gallery::-webkit-scrollbar {
        height: 4px;
      }
      
      .input-gallery::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .input-gallery::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 2px;
      }
      
      .input-gallery .thumb {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        border: 1px solid var(--border-light);
        cursor: pointer;
        transition: transform 0.2s ease;
      }
      
      .input-gallery .thumb:hover {
        transform: scale(1.05);
      }
      
      .input-gallery .thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      
      .input-gallery .thumb .rm {
        position: absolute;
        top: -4px;
        right: -4px;
        width: 16px;
        height: 16px;
        background: var(--danger);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        cursor: pointer;
        border: 1px solid white;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      }
      
      .inputbar textarea {
        flex: 1;
        border: none;
        outline: none;
        font-size: 15px;
        font-family: inherit;
        max-height: 200px;
        resize: none;
        overflow: hidden;
        background: transparent;
        color: var(--text);
        line-height: 1.5;
        position: relative;
        z-index: 1;
      }
      
      .inputbar textarea::placeholder {
        color: var(--text-muted);
      }
      
      .circle[aria-disabled="true"] {
        opacity: 0.4;
        pointer-events: none;
        transform: scale(0.95);
      }
      .circle {
        width: 48px;
        height: 48px;
        border-radius: 16px;
        display: grid;
        place-items: center;
        background: linear-gradient(135deg, var(--brand), var(--brand-hover));
        color: white;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
        font-size: 20px;
      }
      
      .circle::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        transition: left 0.5s;
      }
      
      .circle:hover::before {
        left: 100%;
      }
      
      .circle:hover {
        transform: translateY(-2px) scale(1.05);
        box-shadow: var(--shadow-md);
      }
      
      .circle:active {
        transform: translateY(0) scale(1);
        box-shadow: var(--shadow-sm);
      }
      
      .iconbtn {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: grid;
        place-items: center;
        border: 1px solid var(--border);
        cursor: pointer;
        background: var(--card);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 18px;
        color: var(--text-muted);
        position: relative;
        overflow: hidden;
      }
      
      .iconbtn::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--primary-50);
        opacity: 0;
        transition: opacity 0.2s ease;
      }
      
      .iconbtn:hover {
        transform: translateY(-2px);
        border-color: var(--brand);
        color: var(--brand);
        box-shadow: var(--shadow-md);
      }
      
      .iconbtn:hover::before {
        opacity: 1;
      }
      
      .iconbtn:active {
        transform: translateY(0);
        box-shadow: var(--shadow-sm);
      }

      .support {
        padding: 12px 16px;
        text-align: center;
        color: var(--text-muted);
        font-size: 13px;
        background: var(--primary-50);
        border-radius: 12px;
        margin-top: 12px;
        border: 1px solid var(--primary-100);
      }
      /* 滚动条美化 */
      .chat::-webkit-scrollbar, .side::-webkit-scrollbar {
        width: 8px;
      }
      
      .chat::-webkit-scrollbar-thumb, .side::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 8px;
        transition: background 0.2s ease;
      }
      
      .chat::-webkit-scrollbar-thumb:hover, .side::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
      }
      
      .chat::-webkit-scrollbar-track, .side::-webkit-scrollbar-track {
        background: var(--gray-100);
        border-radius: 8px;
      }
      
      /* TTS 控件 */
      .tts {
        display: flex;
        gap: 8px;
        margin-top: 16px;
        padding: 12px;
        background: var(--gray-50);
        border-radius: 12px;
        border: 1px solid var(--border-light);
      }
      .tts button {
        border: 1px solid var(--border);
        background: var(--card);
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text);
      }
      
      .tts button:hover:not([disabled]) {
        background: var(--primary-50);
        border-color: var(--brand);
        color: var(--brand);
      }
      
      .tts button[disabled] {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      /* 复制按钮特殊样式 */
      .tts button[title*="复制"] {
        background: linear-gradient(135deg, var(--primary-50), var(--success-50));
        border-color: var(--primary-200);
        color: var(--primary-700);
        font-weight: 600;
      }
      
      .tts button[title*="复制"]:hover:not([disabled]) {
        background: linear-gradient(135deg, var(--primary-100), var(--success-100));
        border-color: var(--primary-500);
        color: var(--primary-800);
        transform: translateY(-1px);
        box-shadow: var(--shadow-sm);
      }
      
      /* 模态框 */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s ease;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      .modal-card {
        background: var(--card);
        border-radius: 20px;
        width: 700px;
        max-width: 90vw;
        max-height: 80vh;
        overflow: auto;
        padding: 32px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-xl);
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }
      
      @keyframes slideUp {
        from { 
          opacity: 0;
          transform: translateY(20px) scale(0.95);
        }
        to { 
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }
      
      .modal h3 {
        margin: 0 0 24px 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text);
      }
      
      /* 图片预览模态框右上角关闭按钮 */
      .image-modal-card {
        position: relative;
        background: var(--card);
        border-radius: 20px;
        width: 700px;
        max-width: 90vw;
        max-height: 80vh;
        overflow: auto;
        padding: 32px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-xl);
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .image-close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        background: var(--error-50);
        color: var(--error-500);
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        z-index: 10;
      }
      
      .image-close-btn:hover {
        background: var(--error-500);
        color: white;
        transform: scale(1.1);
      }
      
      /* 历史会话模态框右上角关闭按钮 */
      .history-modal-card {
        position: relative;
        background: var(--card);
        border-radius: 20px;
        width: 700px;
        max-width: 90vw;
        max-height: 80vh;
        overflow: auto;
        padding: 32px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-xl);
        animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      .history-close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 50%;
        background: var(--error-50);
        color: var(--error-500);
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        z-index: 10;
      }
      
      .history-close-btn:hover {
        background: var(--error-500);
        color: white;
        transform: scale(1.1);
      }
      .list {
        display: grid;
        gap: 12px;
      }
      
      .item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid var(--border-light);
        border-radius: 12px;
        padding: 16px 20px;
        background: var(--card);
        transition: all 0.2s ease;
      }
      
      .item:hover {
        border-color: var(--border);
        box-shadow: var(--shadow-sm);
        transform: translateY(-1px);
      }
      
      .actions {
        display: flex;
        gap: 8px;
      }
      
      /* 抽屉背景 */
      .drawer-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.6);
        z-index: 999;
        display: none;
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s ease;
      }
      /* 响应式设计 */
      #btnMenu {
        display: none;
      }
      
      @media (max-width: 1024px) {
        .layout {
          grid-template-columns: 280px 1fr;
        }
        
        .side {
          padding: 20px;
        }
        
        .toolbar {
          padding: 16px 24px;
        }
        
        .composer {
          padding: 20px 24px;
        }
        
        .chat {
          padding: 24px;
        }
      }
      
      @media (max-width: 768px) {
        .layout {
          grid-template-columns: 1fr;
        }
        
        .side {
          position: fixed;
          top: 0;
          left: 0;
          bottom: 0;
          width: 90vw;
          max-width: 380px;
          background: var(--card);
          transform: translateX(-100%);
          transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
          z-index: 1001;
          overflow-y: auto;
          padding: 24px;
          border-right: 1px solid var(--border);
          box-shadow: var(--shadow-xl);
        }
        .side.open {
          transform: translateX(0);
        }
        
        .toolbar {
          position: sticky;
          top: 0;
          z-index: 100;
          padding: 16px 20px;
        }
        
        .brand {
          font-size: 20px;
          font-weight: 700;
          display: flex;
          align-items: center;
          gap: 8px;
        }
        
        #btnMenu {
          display: grid;
          font-weight: 900;
          font-size: 20px;
        }
        
        /* 窄屏下使用更多菜单整合入口，更紧凑；同时隐藏头部用户信息块 */
        #btnTheme, #btnAccount, #btnLogin, #userInfo { display: none; }
        #btnMore { 
          display: grid; 
          font-weight: 900;
          font-size: 20px;
        }
        .user-info { padding: 4px 8px; gap: 6px; min-width: auto; }
        .user-stats { gap: 4px; }
        
        .chat {
          padding: 20px 16px;
        }
        
        .composer {
          padding: 16px 20px;
        }
        
        .inputbar {
          gap: 8px;
          padding: 10px 12px;
        }
        
        .message {
          max-width: 95%;
          padding: 6px 10px;
          margin: 2px 0;
          line-height: 1.1;
          gap: 6px;
        }
        
        .message-icon {
          width: 28px;
          height: 28px;
          font-size: 14px;
        }
        
        .bubble-images img {
          width: 120px;
          height: 120px;
        }
        
        .thumb {
          width: 100px;
          height: 100px;
        }
        
        .group {
          margin-bottom: 16px;
          padding: 16px;
        }
        
        .modal-card {
          padding: 24px;
          margin: 20px;
          max-width: calc(100vw - 40px);
        }
        
        .image-modal-card {
          padding: 24px;
          margin: 20px;
          max-width: calc(100vw - 40px);
        }
        
        .image-close-btn {
          top: 12px;
          right: 12px;
          width: 28px;
          height: 28px;
          font-size: 16px;
        }
        
        .history-modal-card {
          padding: 24px;
          margin: 20px;
          max-width: calc(100vw - 40px);
        }
        
        .history-close-btn {
          top: 12px;
          right: 12px;
          width: 28px;
          height: 28px;
          font-size: 16px;
        }
      }
      
      @media (max-width: 480px) {
        .toolbar {
          padding: 12px 16px;
        }
        
        .brand {
          font-size: 18px;
          font-weight: 700;
          display: flex;
          align-items: center;
          gap: 6px;
        }
        
        .brand::before {
          font-size: 20px;
        }
        
        .chat {
          padding: 16px 12px;
        }
        
        .composer {
          padding: 12px 16px;
        }
        
        /* 超小屏幕输入框适配 */
        .input-content {
          min-height: 18px;
        }
        
        .input-images {
          padding: 4px 0 2px 0;
          margin-bottom: 2px;
        }
        
        .input-gallery {
          gap: 4px;
          max-height: 50px;
          flex-wrap: nowrap;
          overflow-x: auto;
          overflow-y: hidden;
        }
        
        .input-gallery .thumb {
          width: 28px;
          height: 28px;
          border-radius: 4px;
        }
        
        .input-gallery .thumb .rm {
          width: 12px;
          height: 12px;
          font-size: 8px;
          top: -2px;
          right: -2px;
        }
        
        .inputbar textarea {
          font-size: 13px;
          min-height: 18px;
        }
      }
      
      /* iPad 触控优化 */
      @media (min-width: 768px) and (max-width: 1366px) {
        /* 增大触控区域 */
        .iconbtn {
          min-width: 48px;
          min-height: 48px;
          padding: 8px;
        }
        
        .circle {
          min-width: 48px;
          min-height: 48px;
        }
        
        /* 优化按钮间距 */
        .toolbar {
          gap: 12px;
        }
        
        .inputbar {
          gap: 16px;
        }
        
        /* 优化文本选择 */
        .inputbar textarea {
          -webkit-user-select: text;
          user-select: text;
        }
        
        /* 优化滚动条 */
        .chat::-webkit-scrollbar {
          width: 8px;
        }
        
        .chat::-webkit-scrollbar-thumb {
          background: var(--border);
          border-radius: 4px;
        }
        
        /* 优化图片预览 */
        .input-gallery .thumb {
          transition: transform 0.2s ease;
        }
        
        .input-gallery .thumb:active {
          transform: scale(0.95);
        }
        
        /* 优化键盘弹出时的布局 */
        .composer {
          transition: padding 0.3s ease;
        }
        
        /* 支持外接键盘 */
        .inputbar:focus-within {
          box-shadow: 0 0 0 2px var(--brand);
        }
        
        /* iPad 分屏模式优化 */
        .layout {
          min-height: 100vh;
        }
        
        /* 优化侧边栏在iPad上的显示 */
        .side {
          border-right: 1px solid var(--border);
          box-shadow: var(--shadow-lg);
        }
        
        /* 优化消息气泡在iPad上的显示 */
        .message {
          max-width: 80%;
          word-wrap: break-word;
        }
        
        .message.user {
          margin-left: auto;
        }
        
        .message.bot {
          margin-right: auto;
        }
        
        /* 优化图片在iPad上的显示 */
        .bubble-images img {
          max-width: 100%;
          height: auto;
          border-radius: 8px;
        }
        
        /* 优化工具栏在iPad上的显示 */
        .toolbar {
          padding: 16px 24px;
          border-bottom: 1px solid var(--border);
        }
        
        /* 优化输入框在iPad上的显示 */
        .composer {
          border-top: 1px solid var(--border);
          background: var(--card);
        }
        
        .message {
          padding: 4px 8px;
          margin: 1px 0;
          font-size: 14px;
          line-height: 1.0;
          gap: 4px;
        }
        
        .message-icon {
          width: 24px;
          height: 24px;
          font-size: 12px;
        }
        
        .bubble-images img {
          width: 100px;
          height: 100px;
        }
        
        .circle {
          width: 44px;
          height: 44px;
          font-size: 18px;
        }
        
        .iconbtn {
          width: 40px;
          height: 40px;
          font-size: 16px;
        }
        
        /* 移动端汉堡按钮和菜单按钮加粗显示 */
        #btnMenu, #btnMore {
          font-weight: 900;
          font-size: 18px;
        }
        
        .group {
          padding: 12px;
          margin-bottom: 12px;
        }
        
        .modal-card {
          padding: 20px;
          margin: 16px;
        }
        
        .image-modal-card {
          padding: 20px;
          margin: 16px;
        }
        
        .image-close-btn {
          top: 8px;
          right: 8px;
          width: 24px;
          height: 24px;
          font-size: 14px;
        }
        
        .history-modal-card {
          padding: 20px;
          margin: 16px;
        }
        
        .history-close-btn {
          top: 8px;
          right: 8px;
          width: 24px;
          height: 24px;
          font-size: 14px;
        }
        
        /* 账户管理弹出页面响应式 */
        #accountModal .modal-card {
          width: 95vw;
          padding: 20px;
          max-height: 85vh;
        }
        
        #accountModal .group {
          padding: 16px;
          margin-bottom: 16px;
        }
        
        #accountModal .group > div[style*="grid-template-columns"] {
          grid-template-columns: 1fr !important;
          gap: 8px;
        }
        
        #accountModal .hint {
          font-size: 12px;
        }
        
        #accountModal canvas {
          height: 150px !important;
        }
      }
      
      @media (max-width: 480px) {
        #accountModal .modal-card {
          width: 100vw;
          height: 100vh;
          max-width: 100vw;
          max-height: 100vh;
          border-radius: 0;
          margin: 0;
          padding: 16px;
        }
        
        #accountModal h3 {
          font-size: 18px;
        }
        
        #accountModal .group h4 {
          font-size: 16px;
        }
      }
      
      /* 账户管理页面专用样式 */
      .account-modal {
        padding: 0;
        background: var(--bg);
      }
      
      .account-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 24px 32px;
        background: var(--card);
        border-bottom: 1px solid var(--border);
        margin-bottom: 0;
      }
      
      .account-title {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      
      .account-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, var(--brand), var(--brand-hover));
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        box-shadow: var(--shadow-md);
      }
      
      .account-title h3 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        color: var(--text);
      }
      
      .account-subtitle {
        margin: 4px 0 0 0;
        color: var(--text-muted);
        font-size: 14px;
      }
      
      .account-actions {
        display: flex;
        align-items: center;
        gap: 16px;
      }
      
      .account-status {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: var(--success-50);
        border: 1px solid var(--success-500);
        border-radius: 20px;
        color: var(--success-600);
        font-size: 13px;
        font-weight: 500;
      }
      
      .status-dot {
        width: 8px;
        height: 8px;
        background: var(--success-500);
        border-radius: 50%;
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      .close-btn {
        background: var(--error-50);
        border-color: var(--error-500);
        color: var(--error-500);
        font-size: 18px;
        width: 36px;
        height: 36px;
      }
      
      .close-btn:hover {
        background: var(--error-500);
        color: white;
        transform: scale(1.1);
      }
      
      .account-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
        padding: 32px;
      }
      
      .account-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }
      
      .account-card {
        background: var(--card);
        border: 1px solid var(--border-light);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
      }
      
      .account-card:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
      }
      
      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        background: linear-gradient(135deg, var(--primary-50), var(--gray-50));
        border-bottom: 1px solid var(--border-light);
      }
      
      .card-icon {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: white;
        box-shadow: var(--shadow);
      }
      
      .user-icon {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      }
      
      .admin-icon {
        background: linear-gradient(135deg, #f59e0b, #d97706);
      }
      
      .data-icon {
        background: linear-gradient(135deg, #10b981, #059669);
      }
      
      .stats-icon {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      }
      
      .card-title h4 {
        margin: 0;
        font-size: 18px;
        font-weight: 600;
        color: var(--text);
      }
      
      .card-title p {
        margin: 4px 0 0 0;
        color: var(--text-muted);
        font-size: 13px;
      }
      
      .admin-badge {
        padding: 4px 8px;
        background: var(--warning-500);
        color: white;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .card-content {
        padding: 24px;
      }
      
      .form-grid {
        display: grid;
        gap: 20px;
      }
      
      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }
      
      .form-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      
      .form-field label {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        margin: 0;
      }
      
      .form-field input {
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      
      .form-field input:focus {
        border-color: var(--brand);
        box-shadow: 0 0 0 3px var(--brand-light);
      }
      
      .form-field input[readonly] {
        background: var(--gray-50);
        cursor: not-allowed;
      }
      
      .field-hint {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
        padding: 8px 12px;
        background: var(--primary-50);
        border-radius: 6px;
        border: 1px solid var(--primary-100);
      }
      
      .form-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-top: 20px;
      }
      
      .btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
      }
      
      .btn.primary {
        background: linear-gradient(135deg, var(--brand), var(--brand-hover));
        color: white;
        box-shadow: var(--shadow);
      }
      
      .btn.primary:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }
      
      .btn.secondary {
        background: var(--gray-100);
        color: var(--text);
        border: 1px solid var(--border);
      }
      
      .btn.secondary:hover {
        background: var(--gray-200);
        transform: translateY(-1px);
      }
      
      .btn-icon {
        font-size: 16px;
      }
      
      .user-id-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid var(--border-light);
      }
      
      .admin-auth {
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border-light);
      }
      
      .admin-actions {
        display: grid;
        gap: 20px;
      }
      
      .action-group h5 {
        margin: 0 0 12px 0;
        font-size: 14px;
        font-weight: 600;
        color: var(--text-secondary);
      }
      
      .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 8px;
      }
      
      .btn.admin-btn {
        background: var(--warning-50);
        color: var(--warning-600);
        border: 1px solid var(--warning-200);
      }
      
      .btn.admin-btn:hover {
        background: var(--warning-100);
        border-color: var(--warning-300);
      }
      
      .btn.danger {
        background: var(--error-50);
        color: var(--error-600);
        border: 1px solid var(--error-200);
      }
      
      .btn.danger:hover {
        background: var(--error-500);
        color: white;
      }
      
      .btn.data-btn {
        background: var(--success-50);
        color: var(--success-600);
        border: 1px solid var(--success-200);
      }
      
      .btn.data-btn:hover {
        background: var(--success-100);
        border-color: var(--success-300);
      }
      
      .btn.stats-btn {
        background: var(--primary-50);
        color: var(--primary-600);
        border: 1px solid var(--primary-200);
      }
      
      .btn.stats-btn:hover {
        background: var(--primary-100);
        border-color: var(--primary-300);
      }
      
      .quota-settings {
        display: grid;
        gap: 16px;
      }
      
      .data-actions, .stats-controls {
        display: grid;
        gap: 20px;
      }
      
      .search-section {
        display: grid;
        gap: 12px;
      }
      
      .time-range {
        margin-bottom: 20px;
      }
      
      .charts-section {
        grid-column: 1 / -1;
        margin-top: 24px;
        padding: 24px 32px 0;
      }
      
      .charts-header {
        margin-bottom: 24px;
        text-align: center;
      }
      
      .charts-header h4 {
        margin: 0 0 8px 0;
        font-size: 20px;
        font-weight: 600;
        color: var(--text);
      }
      
      .charts-header p {
        margin: 0;
        color: var(--text-muted);
      }
      
      .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
      }
      
      .chart-card {
        background: var(--card);
        border: 1px solid var(--border-light);
        border-radius: 16px;
        overflow: hidden;
        box-shadow: var(--shadow);
      }
      
      .chart-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px 20px;
        background: linear-gradient(135deg, var(--gray-50), var(--primary-50));
        border-bottom: 1px solid var(--border-light);
      }
      
      .chart-header h5 {
        margin: 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--text);
      }
      
      .chart-status {
        padding: 4px 8px;
        background: var(--success-500);
        color: white;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }
      
      .chart-container {
        padding: 20px;
      }
      
      .security-notice {
        grid-column: 1 / -1;
        display: flex;
        gap: 16px;
        padding: 20px;
        background: var(--warning-50);
        border: 1px solid var(--warning-200);
        border-radius: 12px;
        margin-top: 24px;
      }
      
      .notice-icon {
        font-size: 24px;
        color: var(--warning-500);
      }
      
      .notice-content h5 {
        margin: 0 0 12px 0;
        font-size: 16px;
        font-weight: 600;
        color: var(--warning-600);
      }
      
      .notice-content ul {
        margin: 0;
        padding-left: 20px;
        color: var(--warning-600);
        line-height: 1.6;
      }
      
      .notice-content li {
        margin-bottom: 4px;
      }
      
      /* 新增样式：登录页面和用户信息 */
      .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 13px;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s ease;
        min-width: 200px;
      }

      .user-info:hover {
        box-shadow: var(--shadow);
        transform: translateY(-1px);
      }

      .user-basic-info {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }
      
      .user-name {
        font-weight: 600;
        color: var(--text);
        font-size: 13px;
      }
      
      .user-role {
        padding: 2px 8px;
        background: var(--primary-500);
        color: white;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        width: fit-content;
      }

      .user-stats {
        display: flex;
        flex-direction: row;
        gap: 6px;
        padding-left: 8px;
        border-left: 1px solid var(--border-light);
      }

      .stat-item-mini {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 6px;
        min-width: 60px;
      }

      .stat-label-mini {
        font-size: 10px;
        color: var(--text-muted);
        font-weight: 500;
      }

      .stat-value-mini {
        font-size: 12px;
        font-weight: 600;
        color: var(--primary-600);
        background: var(--primary-50);
        padding: 1px 6px;
        border-radius: 4px;
        min-width: 20px;
        text-align: center;
      }

      /* 配额不足时的警告样式 */
      .stat-value-mini.warning {
        color: var(--warning-600);
        background: var(--warning-50);
      }

      .stat-value-mini.error {
        color: var(--error-600);
        background: var(--error-50);
      }

      /* 实时更新动画效果 */
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        20% { opacity: 1; transform: translateY(0); }
        80% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
      }

      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }

      .usage-updated {
        animation: pulse 1s ease-in-out;
      }

      /* 编辑和删除按钮样式 */
      .btn-error {
        background: var(--error-500);
        color: white;
        border: 1px solid var(--error-500);
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-error:hover {
        background: var(--error-600);
        border-color: var(--error-600);
      }

      .btn-error:disabled {
        background: var(--gray-300);
        color: var(--gray-500);
        border-color: var(--gray-300);
        cursor: not-allowed;
      }
      
      .login-modal {
        padding: 0;
      }
      
      .login-header {
        padding: 24px;
        text-align: center;
        background: linear-gradient(135deg, var(--primary-50), var(--gray-50));
        border-bottom: 1px solid var(--border-light);
        position: relative;
      }
      
      .login-header h3 {
        margin: 0 0 8px 0;
        font-size: 24px;
        color: var(--text);
      }
      
      .login-header p {
        margin: 0;
        color: var(--text-muted);
      }
      
      .login-header .close-btn {
        position: absolute;
        top: 16px;
        right: 16px;
      }
      
      .login-content {
        padding: 24px;
      }
      
      .login-tabs {
        display: flex;
        margin-bottom: 24px;
        border-radius: 8px;
        background: var(--gray-100);
        padding: 4px;
      }
      
      .tab-btn {
        flex: 1;
        padding: 8px 16px;
        border: none;
        background: transparent;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        color: var(--text-muted);
      }
      
      .tab-btn.active {
        background: var(--brand);
        color: white;
        box-shadow: var(--shadow-sm);
      }
      
      .tab-content {
        display: none;
      }
      
      .tab-content.active {
        display: block;
      }
      
      .user-modal {
        padding: 0;
      }
      
      .user-content {
        padding: 24px;
        display: grid;
        gap: 24px;
      }
      
      .user-info-display {
        display: grid;
        gap: 12px;
        margin-bottom: 20px;
      }
      
      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-light);
      }
      
      .info-item label {
        font-weight: 500;
        color: var(--text-secondary);
        margin: 0;
      }
      
      .info-item span {
        color: var(--text);
        font-weight: 500;
      }
      
      .usage-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }
      
      .stat-item {
        text-align: center;
        padding: 16px;
        background: linear-gradient(135deg, var(--primary-50), var(--gray-50));
        border-radius: 12px;
        border: 1px solid var(--border-light);
      }
      
      .stat-number {
        font-size: 24px;
        font-weight: 700;
        color: var(--brand);
        margin-bottom: 4px;
      }
      
      .stat-label {
        font-size: 13px;
        color: var(--text-muted);
      }
      
      .btn.small {
        padding: 8px 12px;
        font-size: 12px;
      }
      
      .btn.block {
        width: 100%;
      }
      
      .admin-modal {
        padding: 0;
        background: var(--bg);
      }
      
      .admin-content {
        padding: 24px 32px;
      }
      
      .admin-auth-section {
        margin-bottom: 32px;
        padding: 24px;
        background: var(--warning-50);
        border: 2px solid var(--warning-200);
        border-radius: 16px;
      }
      
      .admin-functions {
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      
      .admin-functions.show {
        opacity: 1;
      }

      /* 上游服务配置样式 */
      .config-icon {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      }

      .current-service-info {
        margin: 12px 0;
        padding: 12px;
        background: var(--gray-50);
        border-radius: 8px;
        border: 1px solid var(--border-light);
      }

      .service-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
      }

      .service-name {
        font-weight: 500;
        color: var(--text);
      }

      .service-status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 500;
      }

      .service-status.healthy {
        background: var(--success-50);
        color: var(--success-600);
      }

      .service-status.unhealthy {
        background: var(--error-50);
        color: var(--error-600);
      }

      .service-status.unreachable {
        background: var(--warning-50);
        color: var(--warning-600);
      }

      .service-status.disabled {
        background: var(--gray-100);
        color: var(--gray-500);
      }

      .upstream-services-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
      }

      .upstream-services-table th,
      .upstream-services-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-light);
      }

      .upstream-services-table th {
        background: var(--gray-50);
        font-weight: 600;
        color: var(--gray-700);
      }

      .upstream-services-table tr:hover {
        background: var(--gray-50);
      }

      .service-actions {
        display: flex;
        gap: 8px;
      }

      .service-actions .btn {
        padding: 4px 8px;
        font-size: 12px;
        margin: 0 2px;
      }

      .service-actions .btn.danger {
        background: var(--error-50);
        color: var(--error-600);
        border: 1px solid var(--error-200);
      }

      .service-actions .btn.danger:hover {
        background: var(--error-100);
        border-color: var(--error-300);
      }
    </style>
  </head>
  <body>
    <div class="layout">
      <aside class="side">
        <div class="group">
          <label class="block">🤖 AI 医疗模型</label>
          <select id="model">
            <option value="hf.co/unsloth/medgemma-4b-it-GGUF:Q4_K_M" selected>MedGemm多模态</option>
          </select>
        </div>

        <div class="group">
          <label class="block">📊 诊断能力状态</label>
          <div style="display:grid; gap:12px">
            <div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
                <span style="font-size:13px; color:var(--text-secondary)">🔬 影像分析</span>
                <span style="font-size:12px; color:var(--success-600)">就绪</span>
              </div>
          <div class="meter"><span style="width:100%"></span></div>
            </div>
            <div>
              <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px">
                <span style="font-size:13px; color:var(--text-secondary)">💬 症状问诊</span>
                <span style="font-size:12px; color:var(--success-600)">就绪</span>
              </div>
              <div class="meter"><span style="width:100%"></span></div>
            </div>
          </div>
        </div>

        <div class="group">
          <label class="block">📈 会话统计</label>
          <div class="meter"><span style="width:0%"></span></div>
          <div class="row"><span id="msgCount">0 条消息</span><span style="color:var(--success-600)">● 在线</span></div>
        </div>

        <div class="group">
          <label class="block">🩺 专业诊断功能</label>
          <div class="checks">
            <label><input type="checkbox" id="chkImg" checked> 🖼️ 医学影像分析</label>
            <label><input type="checkbox" id="chkTxt" checked> 📝 症状文本分析</label>
            <label><input type="checkbox" id="chkEhr"> 📋 电子病历分析</label>
          </div>
          <div class="hint" style="margin-top:12px; padding:8px 12px; background:var(--warning-50); border:1px solid var(--warning-500); border-radius:8px; color:var(--warning-500)">
            ⚠️ 仅供医学参考，不可替代专业医生诊断
          </div>
        </div>

        <div class="group" style="display:grid; gap:12px">
          <button class="btn block" id="btnNew">🩺 开始新的诊疗</button>
          <button class="btn ghost block" id="btnHistory">📋 查看诊疗历史</button>
          <button class="btn ghost block" id="btnExport">📄 导出诊疗报告</button>
        </div>

      </aside>

      <section class="main">
        <div class="toolbar">
          <div style="display:flex; align-items:center; gap:10px">
            <div class="iconbtn" id="btnMenu" title="菜单">☰</div>
            <div class="brand">🩺 AI 诊疗助手</div>
          </div>
          <div style="display:flex; align-items:center; gap:8px">
            <!-- 项目要求：不显示宣传性说明 -->
            <div class="user-info" id="userInfo" style="display:none">
              <div class="user-basic-info">
                <span class="user-name" id="currentUserName">未登录</span>
                <div class="user-role" id="currentUserRole">访客</div>
              </div>
              <div class="user-stats" id="userStats">
                <div class="stat-item-mini"><span class="stat-label-mini">今日</span><span class="stat-value-mini" id="todayUsageMini">0</span></div>
                <div class="stat-item-mini"><span class="stat-label-mini">剩余</span><span class="stat-value-mini" id="remainingQuotaMini">∞</span></div>
              </div>
            </div>
            <div class="iconbtn" id="btnLogin" title="登录/注册">🔑</div>
            <div class="iconbtn" id="btnAccount" title="我的账户" style="display:none">👤</div>
            <div class="iconbtn" id="btnAdmin" title="管理控制台" style="display:none">⚙️</div>
            <div class="iconbtn" id="btnTheme" title="切换主题">🌓</div>
            <div class="iconbtn" id="btnMore" title="更多">⋮</div>
          </div>
        </div>


  <div class="chat" id="chat" style="width:100%;max-width:1200px;min-width:900px;height:70vh;max-height:700px;min-height:400px;overflow-y:auto;margin:32px auto 0 auto;background:var(--card);border-radius:22px;box-shadow:var(--shadow-xl);padding:40px 40px 32px 40px;display:flex;flex-direction:column;gap:20px;">
          <div class="empty" id="empty">
            <div style="font-size:48px">🩺</div>
            <div style="font-weight:600; font-size:24px; color:var(--text)">欢迎使用 AI 医疗诊疗助手</div>
            <div class="hint" style="font-size:16px; text-align:center; max-width:400px">
              请描述症状或上传医学影像,获得AI驱动的见解和诊断
              <br><br>
              协助您进行症状分析、医学图像解读和健康咨询
            </div>
            <div class="drop" id="dropArea">
              <div style="font-size:20px; margin-bottom:8px">📤</div>
              <div>拖拽医疗图像到此处上传</div>
              <div style="font-size:12px; margin-top:4px; opacity:0.7">支持 JPEG、PNG、GIF、WebP、BMP 格式，最大 5MB</div>
            </div>
          </div>
        </div>

        <div class="composer">
          <div class="inputbar">
            <div class="iconbtn" id="pickImg" title="上传图片">📎</div>
            <div class="iconbtn" id="btnPresetsIcon" title="预设提示词">⭐</div>
            <div class="iconbtn" id="mic" title="语音（占位）">🎙️</div>
            
            <!-- 输入框内容区域：包含文本输入和图片缩略图 -->
            <div class="input-content">
              <!-- 图片缩略图区域 -->
              <div class="input-images" id="inputImages" style="display: none;">
                <div class="input-gallery" id="gallery"></div>
              </div>
              <!-- 文本输入框 -->
              <textarea id="prompt" rows="1" placeholder="请描述症状或上传图片..."></textarea>
            </div>
            
            <div class="circle" id="send" title="发送消息" aria-disabled="true">➤</div>
          </div>
          <div class="support" style="display: none;">
            <div style="display:flex; align-items:center; justify-content:center; gap:8px; flex-wrap:wrap">
              <span>🏥 专业医疗AI助手</span>
              <span>📸 支持医学影像分析</span>
              <span>💬 智能症状问诊</span>
              <span>🔒 隐私安全保护</span>
            </div>
          </div>
          <input id="file" type="file" accept="image/*" style="display:none" />
        </div>
      </section>
    </div>
    <div class="drawer-backdrop" id="drawerBackdrop"></div>
    <!-- 顶部更多-汉堡菜单 -->
    <div id="moreMenu" class="modal" style="display:none; align-items:flex-start; justify-content:flex-end;">
      <div class="modal-card" style="margin:12px; width:220px; padding:8px">
        <div id="mmUserPanel" style="display:none; padding:8px; margin-bottom:6px; border:1px solid var(--border); border-radius:8px; background:var(--card)">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:6px; margin-bottom:4px">
            <span id="mmUserName" style="font-weight:600">-</span>
            <span id="mmUserRole" style="font-size:10px; padding:2px 6px; border-radius:12px; background:var(--primary-500); color:#fff">用户</span>
          </div>
          <div style="display:flex; gap:6px">
            <div style="display:flex; gap:4px; align-items:center">
              <span style="font-size:10px; color:var(--text-muted)">今日</span>
              <span id="mmToday" style="font-size:12px; font-weight:600; color:var(--primary-600); background:var(--primary-50); padding:1px 6px; border-radius:4px">0</span>
            </div>
            <div style="display:flex; gap:4px; align-items:center">
              <span style="font-size:10px; color:var(--text-muted)">剩余</span>
              <span id="mmRemain" style="font-size:12px; font-weight:600; color:var(--primary-600); background:var(--primary-50); padding:1px 6px; border-radius:4px">∞</span>
            </div>
          </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:6px">
          <button class="btn ghost" id="mmAccount">👤 我的账户</button>
          <button class="btn ghost" id="mmTheme">🌓 切换主题</button>
          <button class="btn ghost" id="mmLogin">🔑 登录/切换用户</button>
          <button class="btn ghost" id="mmAdmin" style="display:none">⚙️ 管理员控制台</button>
          <button class="btn ghost" id="mmLogout" style="display:none">🚪 退出登录</button>
        </div>
      </div>
    </div>

    <!-- 登录/注册页面 -->
    <div id="loginModal" class="modal" style="display: none;">
      <div class="modal-card login-modal" style="width: 450px; max-width: 90vw;">
        <div class="login-header">
          <h3>🔑 用户登录</h3>
          <p>登录您的账户以使用完整功能</p>
          <div class="iconbtn close-btn" id="closeLoginModal" title="关闭">×</div>
        </div>
        <div class="login-content">
          <div class="login-tabs">
            <button class="tab-btn active" data-tab="login">登录</button>
            <button class="tab-btn" data-tab="register">注册</button>
          </div>
          
          <!-- 登录表单 -->
          <div class="tab-content active" id="loginTab">
            <div class="form-grid">
              <div class="form-field">
                <label>邮箱地址</label>
                <input id="loginEmail" type="email" placeholder="请输入邮箱地址" />
              </div>
              <div class="form-field">
                <label>登录密码</label>
                <input id="loginPassword" type="password" placeholder="请输入密码" />
              </div>
              <button class="btn primary block" id="btnDoLogin">
                <span class="btn-icon">🔑</span>
                登录账户
              </button>
            </div>
            
            <!-- 账户提示信息 -->
            <div style="margin-top: 20px; padding: 16px; background: var(--primary-50); border-radius: 12px; border-left: 4px solid var(--brand); display: none;">
              <h5 style="margin: 0 0 8px 0; color: var(--primary-700); font-size: 14px;">💡 账户类型说明</h5>
              <div style="font-size: 13px; color: var(--primary-600); line-height: 1.4;">
                <p style="margin: 4px 0;"><strong>🔐 管理员账户：</strong></p>
                <p style="margin: 2px 0 8px 16px; font-family: 'Courier New', monospace; background: var(--primary-100); padding: 4px 8px; border-radius: 6px;">
                  admin@medgemma.com<br>
                  SecureAdmin2024!
                </p>
                <p style="margin: 4px 0;"><strong>👤 演示账户：</strong></p>
                <p style="margin: 2px 0 0 16px; font-family: 'Courier New', monospace; background: var(--primary-100); padding: 4px 8px; border-radius: 6px;">
                  demo@test.com<br>
                  demo123
                </p>
              </div>
            </div>
          </div>
          
          <!-- 注册表单 -->
          <div class="tab-content" id="registerTab">
            <div class="form-grid">
              <div class="form-row">
                <div class="form-field">
                  <label>姓名</label>
                  <input id="regName" placeholder="请输入您的姓名" />
                </div>
                <div class="form-field">
                  <label>工作单位</label>
                  <input id="regOrg" placeholder="请输入工作单位" />
                </div>
              </div>
              <div class="form-row">
                <div class="form-field">
                  <label>手机号码</label>
                  <input id="regPhone" placeholder="请输入手机号码" />
                </div>
                <div class="form-field">
                  <label>邮箱地址</label>
                  <input id="regEmail" type="email" placeholder="请输入邮箱地址" />
                </div>
              </div>
              <div class="form-field">
                <label>设置密码</label>
                <input id="regPassword" type="password" placeholder="请设置登录密码（至少6位）" />
              </div>
              <button class="btn primary block" id="btnDoRegister">
                <span class="btn-icon">📝</span>
                注册账户
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 用户账户页面 -->
    <div id="userAccountModal" class="modal" style="display: none;">
      <div class="modal-card user-modal" style="width: 600px; max-width: 90vw;">
        <div class="account-header">
          <div class="account-title">
            <div class="account-icon user-icon">👤</div>
            <div>
              <h3>我的账户</h3>
              <p class="account-subtitle">个人信息 · 使用统计 · 账户设置</p>
            </div>
          </div>
          <div class="account-actions">
            <button class="btn secondary small" id="btnLogout">
              <span class="btn-icon">🚪</span>
              退出登录
            </button>
            <div class="iconbtn close-btn" id="closeUserAccountModal" title="关闭">×</div>
          </div>
        </div>
        
        <div class="user-content">
          <!-- 个人信息 -->
          <div class="account-card">
            <div class="card-header">
              <div class="card-icon user-icon">📝</div>
              <div class="card-title">
                <h4>个人信息</h4>
                <p>查看和修改您的基本信息</p>
              </div>
            </div>
            <div class="card-content">
              <div class="user-info-display">
                <div class="info-item">
                  <label>用户ID</label>
                  <span id="userIdDisplay">-</span>
                </div>
                <div class="info-item">
                  <label>姓名</label>
                  <span id="userNameDisplay">-</span>
                </div>
                <div class="info-item">
                  <label>邮箱</label>
                  <span id="userEmailDisplay">-</span>
                </div>
                <div class="info-item">
                  <label>工作单位</label>
                  <span id="userOrgDisplay">-</span>
                </div>
                <div class="info-item">
                  <label>手机号码</label>
                  <span id="userPhoneDisplay">-</span>
                </div>
              </div>
              <button class="btn secondary" id="btnChangePassword">
                <span class="btn-icon">🔒</span>
                修改密码
              </button>
            </div>
          </div>
          
          <!-- 使用统计 -->
          <div class="account-card">
            <div class="card-header">
              <div class="card-icon stats-icon">📊</div>
              <div class="card-title">
                <h4>使用统计</h4>
                <p>您的诊疗服务使用情况</p>
              </div>
              <div style="margin-left: auto;">
                <button onclick="refreshUsageStats()" class="btn-icon" title="刷新最新数据" style="padding: 8px 12px; font-size: 12px; background: var(--primary-100); color: var(--primary-700); border: 1px solid var(--primary-200);">
                  🔄 刷新
                </button>
              </div>
            </div>
            <div class="card-content">
              <div class="usage-stats">
                <div class="stat-item">
                  <div class="stat-number" id="totalUsage">0</div>
                  <div class="stat-label">总使用次数</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="todayUsage">0</div>
                  <div class="stat-label">今日使用</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number" id="remainingQuota">∞</div>
                  <div class="stat-label">剩余配额</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 管理员控制台 -->
    <div id="adminModal" class="modal" style="display: none;">
      <div class="modal-card admin-modal" style="width: 1200px; max-width: 95vw; max-height: 92vh;">
        <div class="account-header">
          <div class="account-title">
            <div class="account-icon admin-icon">⚙️</div>
            <div>
              <h3>管理员控制台</h3>
              <p class="account-subtitle">用户管理 · 系统配置 · 数据分析 · 运营监控</p>
            </div>
          </div>
          <div class="account-actions">
            <div class="admin-badge">管理员专用</div>
            <div class="account-status">
              <span class="status-dot"></span>
              <span>系统正常运行</span>
            </div>
            <div class="iconbtn close-btn" id="closeAdminModal" title="关闭">×</div>
          </div>
        </div>

        <div class="admin-content">
          <!-- 管理员认证 -->
          <div class="admin-auth-section">
            <div class="form-field">
              <label>管理员令牌验证</label>
              <input id="adminTokenInput" placeholder="请输入 ADMIN_TOKEN 以验证管理员身份" type="password" />
              <div class="field-hint">
                🔐 需要有效的管理员令牌才能访问系统管理功能
              </div>
            </div>
          </div>

          <!-- 管理功能区域 -->
          <div class="admin-functions" id="adminFunctions" style="display: none;">
            <div class="account-content">
              <!-- 左侧：用户管理 -->
              <div class="account-section">
                <!-- 用户管理 -->
                <div class="account-card">
                  <div class="card-header">
                    <div class="card-icon user-icon">👥</div>
                    <div class="card-title">
                      <h4>用户管理</h4>
                      <p>管理系统用户和权限</p>
                    </div>
                  </div>
                  <div class="card-content">
                    <div class="admin-actions">
                      <div class="action-group">
                        <h5>用户操作</h5>
                        <div class="action-buttons">
                          <button class="btn admin-btn" id="btnListUsers">
                            <span class="btn-icon">👥</span>
                            列出用户
                          </button>
                          <button class="btn admin-btn" id="btnSearchUsers">
                            <span class="btn-icon">🔍</span>
                            搜索用户
                          </button>
                        </div>
                      </div>
                      <div class="form-field">
                        <label>搜索关键字</label>
                        <input id="searchInput" placeholder="输入邮箱、姓名或手机号进行搜索" />
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 配额管理 -->
                <div class="account-card">
                  <div class="card-header">
                    <div class="card-icon admin-icon">📊</div>
                    <div class="card-title">
                      <h4>配额管理</h4>
                      <p>设置用户使用配额限制</p>
                    </div>
                  </div>
                  <div class="card-content">
                    <div class="quota-settings">
                      <div class="form-field">
                        <label>目标用户ID</label>
                        <input id="userIdInput" placeholder="要设置配额的用户ID" />
                      </div>
                      <div class="form-row">
                        <div class="form-field">
                          <label>总配额限制</label>
                          <input id="quotaInput" placeholder="留空为不限制" type="number" />
                        </div>
                        <div class="form-field">
                          <label>日配额限制</label>
                          <input id="dailyQuotaInput" placeholder="留空为不限制" type="number" />
                        </div>
                      </div>
                      <div class="action-buttons">
                        <button class="btn admin-btn" id="btnSetQuota">
                          <span class="btn-icon">📊</span>
                          设定配额
                        </button>
                        <button class="btn admin-btn danger" id="btnResetUsage">
                          <span class="btn-icon">🔄</span>
                          重置用量
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 右侧：数据管理与分析 -->
              <div class="account-section">
                <!-- 上游服务配置 -->
                <div class="account-card">
                  <div class="card-header">
                    <div class="card-icon config-icon">⚙️</div>
                    <div class="card-title">
                      <h4>上游服务配置</h4>
                      <p>管理MedGemma上游服务</p>
                    </div>
                  </div>
                  <div class="card-content">
                    <div class="admin-actions">
                      <div class="action-group">
                        <h5>服务管理</h5>
                        <div class="action-buttons">
                          <button class="btn admin-btn" id="btnListUpstreamServices">
                            <span class="btn-icon">📋</span>
                            列出服务
                          </button>
                          <button class="btn admin-btn" id="btnAddUpstreamService">
                            <span class="btn-icon">➕</span>
                            添加服务
                          </button>
                          <button class="btn admin-btn" id="btnCheckUpstreamHealth">
                            <span class="btn-icon">🏥</span>
                            健康检查
                          </button>
                        </div>
                      </div>
                      <div class="action-group">
                        <h5>当前服务</h5>
                        <div class="current-service-info" id="currentServiceInfo">
                          <div class="service-item">
                            <span class="service-name">加载中...</span>
                            <span class="service-status">-</span>
                          </div>
                        </div>
                        <div class="action-buttons">
                          <button class="btn admin-btn" id="btnSwitchUpstreamService">
                            <span class="btn-icon">🔄</span>
                            切换服务
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- 数据管理 -->
                <div class="account-card">
                  <div class="card-header">
                    <div class="card-icon data-icon">📊</div>
                    <div class="card-title">
                      <h4>数据管理</h4>
                      <p>用户数据的导入导出</p>
                    </div>
                  </div>
                  <div class="card-content">
                    <div class="data-actions">
                      <div class="action-buttons">
                        <button class="btn data-btn" id="btnExportCsv">
                          <span class="btn-icon">📤</span>
                          导出CSV
                        </button>
                        <button class="btn data-btn" id="btnImportCsv">
                          <span class="btn-icon">📥</span>
                          导入CSV
                        </button>
                      </div>
                      <input id="csvFile" type="file" accept="text/csv,.csv" style="display: none;" />
                    </div>
                  </div>
                </div>

                <!-- 使用统计 -->
                <div class="account-card">
                  <div class="card-header">
                    <div class="card-icon stats-icon">📈</div>
                    <div class="card-title">
                      <h4>使用统计分析</h4>
                      <p>系统使用情况的多维度分析</p>
                    </div>
                  </div>
                  <div class="card-content">
                    <div class="stats-controls">
                      <div class="time-range">
                        <div class="form-row">
                          <div class="form-field">
                            <label>开始时间</label>
                            <input id="startInput" type="datetime-local" />
                          </div>
                          <div class="form-field">
                            <label>结束时间</label>
                            <input id="endInput" type="datetime-local" />
                          </div>
                        </div>
                      </div>
                      <div class="action-buttons stats-buttons">
                        <button class="btn stats-btn" id="btnUsageSummary">
                          <span class="btn-icon">📊</span>
                          用量汇总
                        </button>
                        <button class="btn stats-btn" id="btnUsageByUser">
                          <span class="btn-icon">👤</span>
                          按用户统计
                        </button>
                        <button class="btn stats-btn" id="btnUsageByDay">
                          <span class="btn-icon">📅</span>
                          按日期统计
                        </button>
                        <button class="btn stats-btn" id="btnPaged2">
                          <span class="btn-icon">📋</span>
                          分页查询
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 图表展示区域 -->
            <div class="charts-section">
              <div class="charts-header">
                <h4>📊 数据可视化</h4>
                <p>系统使用情况的图表展示</p>
              </div>
              <div class="charts-grid">
                <div class="chart-card">
                  <div class="chart-header">
                    <h5>📈 按日用量趋势</h5>
                    <div class="chart-status">实时更新</div>
                  </div>
                  <div class="chart-container">
                    <canvas id="usageChartDay" height="200"></canvas>
                  </div>
                </div>
                <div class="chart-card">
                  <div class="chart-header">
                    <h5>👥 用户使用排行 (Top 10)</h5>
                    <div class="chart-status">实时更新</div>
                  </div>
                  <div class="chart-container">
                    <canvas id="usageChartUser" height="200"></canvas>
                  </div>
                </div>
              </div>
            </div>

            <!-- 安全提示 -->
            <div class="security-notice">
              <div class="notice-icon">⚠️</div>
              <div class="notice-content">
                <h5>管理员安全提示</h5>
                <ul>
                  <li>管理员功能具有系统级权限，请谨慎操作</li>
                  <li>用户配额设置后立即生效，建议先测试</li>
                  <li>CSV 导入会按邮箱进行用户数据更新</li>
                  <li>定期备份重要数据，避免意外丢失</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <script>
      const chat = document.getElementById('chat');
      const empty = document.getElementById('empty');
      const promptEl = document.getElementById('prompt');
      const sendBtn = document.getElementById('send');
      const modelEl = document.getElementById('model');
      const msgCountEl = document.getElementById('msgCount');
      const pickImgBtn = document.getElementById('pickImg');
      const fileEl = document.getElementById('file');
      const dropArea = document.getElementById('dropArea');
      const gallery = document.getElementById('gallery');
      const inputImages = document.getElementById('inputImages');
      const btnNew = document.getElementById('btnNew');
      const btnExport = document.getElementById('btnExport');
      const btnHistory = document.getElementById('btnHistory');
      const btnPresetsIcon = document.getElementById('btnPresetsIcon');
      const btnMenu = document.getElementById('btnMenu');
      const drawerBackdrop = document.getElementById('drawerBackdrop');
      const nameInput = document.getElementById('nameInput');
      const orgInput = document.getElementById('orgInput');
      const phoneInput = document.getElementById('phoneInput');
      const emailInput = document.getElementById('emailInput');
      const pwdInput = document.getElementById('pwdInput');
      const userIdInput = document.getElementById('userIdInput');
      // 自动修复：如果没有登录用户，默认填充一个可用ID（如4）
      if (userIdInput && !userIdInput.value) {
        userIdInput.value = '4';
      }
      const adminTokenInput = document.getElementById('adminTokenInput');
      const adminFunctions = document.getElementById('adminFunctions');
      const quotaInput = document.getElementById('quotaInput');
      const dailyQuotaInput = document.getElementById('dailyQuotaInput');
      const btnResetUsage = document.getElementById('btnResetUsage');
      const btnExportCsv = document.getElementById('btnExportCsv');
      const searchInput = document.getElementById('searchInput');
      const btnSearchUsers = document.getElementById('btnSearchUsers');
      const csvFile = document.getElementById('csvFile');
      const btnImportCsv = document.getElementById('btnImportCsv');
      const startInput = document.getElementById('startInput');
      const endInput = document.getElementById('endInput');
      const btnUsageSummary = document.getElementById('btnUsageSummary');
      const btnUsageByUser = document.getElementById('btnUsageByUser');
      const btnUsageByDay = document.getElementById('btnUsageByDay');
      const btnPaged2 = document.getElementById('btnPaged2');
      // 图表实例缓存
      let __chartDay = null;
      let __chartUser = null;

      function renderLineChart(canvasId, labels, data){
        const ctx = document.getElementById(canvasId).getContext('2d');
        if(canvasId==='usageChartDay' && __chartDay){ __chartDay.destroy(); }
        if(canvasId==='usageChartUser' && __chartUser){ __chartUser.destroy(); }
        const inst = new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: '数量', data, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.15)', fill:true, tension:.2 }] },
          options: { plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ maxRotation:0 } }, y:{ beginAtZero:true, precision:0 } } }
        });
        if(canvasId==='usageChartDay') __chartDay = inst; else __chartUser = inst;
      }

      const btnRegister = document.getElementById('btnRegister');
      const btnChangePwd = document.getElementById('btnChangePwd');
      const btnListUsers = document.getElementById('btnListUsers');
      const btnSetQuota = document.getElementById('btnSetQuota');
      const btnTheme = document.getElementById('btnTheme');
      const btnLogin = document.getElementById('btnLogin');
      const btnAccount = document.getElementById('btnAccount');
      const btnAdmin = document.getElementById('btnAdmin');
      const btnMore = document.getElementById('btnMore');
      const userInfo = document.getElementById('userInfo');
      const currentUserName = document.getElementById('currentUserName');
      const currentUserRole = document.getElementById('currentUserRole');
      
      // 模态框元素
      const loginModal = document.getElementById('loginModal');
      const userAccountModal = document.getElementById('userAccountModal');
      const adminModal = document.getElementById('adminModal');
      
      // 关闭按钮
      const closeLoginModal = document.getElementById('closeLoginModal');
      const closeUserAccountModal = document.getElementById('closeUserAccountModal');
      const closeAdminModal = document.getElementById('closeAdminModal');
      
      // 当前用户状态
      let currentUser = null;

      let imagesBase64 = [];
      function isNarrow(){ return window.matchMedia('(max-width: 768px)').matches; }
      function collapseSideIfNarrow(){
        try{
          if(isNarrow()){
            const side = document.querySelector('.side');
            if (side && side.classList.contains('open')) side.classList.remove('open');
            if (typeof drawerBackdrop !== 'undefined' && drawerBackdrop) drawerBackdrop.style.display = 'none';
          }
        }catch{}
      }
      // 主题切换
      (function(){
        const saved = localStorage.getItem('theme') || 'light';
        if(saved==='dark'){ document.documentElement.classList.add('dark'); }
        btnTheme?.addEventListener('click', ()=>{
          const isDark = document.documentElement.classList.toggle('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
      })();

      // 用户状态管理
      function updateUserUI() {
        if (currentUser) {
          // 已登录状态（统一通过更多菜单展示登录/账户）
          btnLogin.style.display = 'none';
          btnAccount.style.display = 'none';
          userInfo.style.display = isNarrow() ? 'none' : 'flex';
          currentUserName.textContent = currentUser.name || currentUser.email;
          currentUserRole.textContent = currentUser.is_admin ? '管理员' : '用户';
          currentUserRole.style.background = currentUser.is_admin ? 'var(--warning-500)' : 'var(--primary-500)';
          
          // 管理员入口统一放到更多菜单（桌面与移动端一致）
          btnAdmin.style.display = 'none';
          const mmAdmin = document.getElementById('mmAdmin');
          if (mmAdmin) mmAdmin.style.display = currentUser.is_admin ? 'block' : 'none';
          // 更多菜单：显示账户、退出；隐藏登录
          const mmAccount = document.getElementById('mmAccount');
          if (mmAccount) mmAccount.style.display = 'block';
          const mmLogin = document.getElementById('mmLogin');
          if (mmLogin) mmLogin.style.display = 'none';
          const mmLogout = document.getElementById('mmLogout');
          if (mmLogout) mmLogout.style.display = 'block';
        } else {
          // 未登录状态
          btnLogin.style.display = 'none';
          btnAccount.style.display = 'none';
          btnAdmin.style.display = 'none';
          const mmAdmin = document.getElementById('mmAdmin');
          if (mmAdmin) mmAdmin.style.display = 'none';
          const mmAccount = document.getElementById('mmAccount');
          if (mmAccount) mmAccount.style.display = 'none';
          const mmLogin = document.getElementById('mmLogin');
          if (mmLogin) mmLogin.style.display = 'block';
          const mmLogout = document.getElementById('mmLogout');
          if (mmLogout) mmLogout.style.display = 'none';
          userInfo.style.display = 'none';
        }
      }

      // 监听窗口尺寸变化，确保窄屏时不显示头部用户信息
      window.addEventListener('resize', () => {
        if (!currentUser) return;
        userInfo.style.display = isNarrow() ? 'none' : 'flex';
      });

      // 登录页面事件
      btnLogin?.addEventListener('click', () => {
        collapseSideIfNarrow();
        loginModal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      });

      // 用户账户页面事件
      btnAccount?.addEventListener('click', () => {
        if (currentUser) {
          collapseSideIfNarrow();
          loadUserAccountData();
          updateUsageStats(); // 确保显示最新的使用统计
          userAccountModal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }
      });

      // 管理员控制台事件
      btnAdmin?.addEventListener('click', () => {
        if (currentUser && currentUser.is_admin) {
          collapseSideIfNarrow();
          adminModal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }
      });

      // 模态框关闭事件
      function closeModal(modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
      }

      closeLoginModal?.addEventListener('click', () => closeModal(loginModal));
      closeUserAccountModal?.addEventListener('click', () => closeModal(userAccountModal));
      closeAdminModal?.addEventListener('click', () => closeModal(adminModal));

      // 点击背景关闭模态框
      const moreMenu = document.getElementById('moreMenu');

      [loginModal, userAccountModal, adminModal, moreMenu].forEach(modal => {
        modal?.addEventListener('click', (e) => {
          if (e.target === modal) {
            closeModal(modal);
          }
        });
      });

      // ESC键关闭模态框
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          [loginModal, userAccountModal, adminModal, moreMenu].forEach(modal => {
            if (modal && modal.style.display === 'flex') {
              closeModal(modal);
            }
          });
        }
      });

      // 更多菜单逻辑（移动端/窄屏整合入口）
      btnMore?.addEventListener('click', () => {
        moreMenu.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        // 在窄屏时，将用户信息与今日/剩余填充到更多菜单
        const userPanel = document.getElementById('mmUserPanel');
        if (window.matchMedia('(max-width: 768px)').matches && currentUser) {
          userPanel.style.display = 'block';
          const nameEl = document.getElementById('mmUserName');
          const roleEl = document.getElementById('mmUserRole');
          const todayEl = document.getElementById('mmToday');
          const remainEl = document.getElementById('mmRemain');
          if (nameEl) nameEl.textContent = currentUser.name || currentUser.email;
          if (roleEl) {
            roleEl.textContent = currentUser.is_admin ? '管理员' : '用户';
            roleEl.style.background = currentUser.is_admin ? 'var(--warning-500)' : 'var(--primary-500)';
          }
          if (todayEl) todayEl.textContent = String(currentUser.daily_used || 0);
          if (remainEl) remainEl.textContent = currentUser.usage_quota ? String(Math.max(currentUser.usage_quota - (currentUser.usage_used||0), 0)) : '∞';
        } else {
          userPanel.style.display = 'none';
        }
      });
      document.getElementById('mmAccount')?.addEventListener('click', () => {
        closeModal(moreMenu);
        btnAccount?.click();
      });
      document.getElementById('mmTheme')?.addEventListener('click', () => {
        closeModal(moreMenu);
        btnTheme?.click();
      });
      document.getElementById('mmLogin')?.addEventListener('click', () => {
        closeModal(moreMenu);
        btnLogin?.click();
      });
      document.getElementById('mmAdmin')?.addEventListener('click', () => {
        closeModal(moreMenu);
        btnAdmin?.click();
      });
      document.getElementById('mmLogout')?.addEventListener('click', () => {
        closeModal(moreMenu);
        document.getElementById('btnLogout')?.click();
      });

      // 登录/注册标签切换
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(tab + 'Tab').classList.add('active');
        });
      });

      // 加载用户账户数据
      function loadUserAccountData() {
        if (currentUser) {
          document.getElementById('userIdDisplay').textContent = currentUser.id;
          document.getElementById('userNameDisplay').textContent = currentUser.name || '-';
          document.getElementById('userEmailDisplay').textContent = currentUser.email || '-';
          document.getElementById('userOrgDisplay').textContent = currentUser.organization || '-';
          document.getElementById('userPhoneDisplay').textContent = currentUser.phone || '-';
          updateUsageStats();
        }
      }

      // 更新使用统计（从数据库获取最新数据）
      async function updateUsageStats() {
        if (!currentUser) return;
        
        try {
          // 直接从数据库获取最新数据
          const response = await fetch('/api/admin/users', {
            headers: { 'X-Admin-Token': 'secret-admin' }
          });
          
          if (response.ok) {
            const users = await response.json();
            const serverUserData = users.find(user => user.id === currentUser.id);
            
            if (serverUserData) {
              // 使用服务器数据更新显示
              document.getElementById('totalUsage').textContent = serverUserData.usage_used || '0';
              document.getElementById('todayUsage').textContent = serverUserData.daily_used || '0';
              
              const remaining = serverUserData.usage_quota ? 
                (serverUserData.usage_quota - (serverUserData.usage_used || 0)) : '∞';
              document.getElementById('remainingQuota').textContent = remaining;
              
              // 更新头部实时统计显示
              await updateHeaderStats();
            }
          }
        } catch (error) {
          // 如果获取失败，显示错误状态
          console.warn('获取使用统计失败:', error);
          document.getElementById('totalUsage').textContent = '?';
          document.getElementById('todayUsage').textContent = '?';
          document.getElementById('remainingQuota').textContent = '?';
        }
      }

      // 刷新使用统计数据（纯数据库模式）
      async function refreshUsageStats() {
        if (!currentUser) return;
        
        try {
          await updateUsageStats();
          // 移除弹窗通知，改为后台静默更新
          console.log('📊 使用统计已静默刷新');
        } catch (error) {
          console.warn('刷新使用统计失败:', error);
          // 只在控制台记录错误，不显示弹窗
        }
      }

      // 显示同步通知
      function showSyncNotification(message) {
        // 创建通知元素
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: var(--success-100);
          color: var(--success-700);
          padding: 12px 20px;
          border-radius: 8px;
          border: 1px solid var(--success-200);
          font-size: 14px;
          font-weight: 600;
          z-index: 10000;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          animation: slideInRight 0.3s ease-out;
        `;
        notification.textContent = message;
        
        // 添加动画样式
        const style = document.createElement('style');
        style.textContent = `
          @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
          }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(notification);
        
        // 3秒后自动移除
        setTimeout(() => {
          if (notification.parentNode) {
            notification.style.animation = 'slideInRight 0.3s ease-out reverse';
            setTimeout(() => {
              if (notification.parentNode) {
                document.body.removeChild(notification);
              }
            }, 300);
          }
        }, 3000);
      }

      // 定期刷新机制（纯数据库模式）
      let usageRefreshInterval = null;
      
      // 启动定期刷新
      function startUsageSync() {
        if (usageRefreshInterval) {
          clearInterval(usageRefreshInterval);
        }
        
        // 每30秒从数据库刷新一次使用统计数据
        usageRefreshInterval = setInterval(async () => {
          await updateUsageStats();
        }, 30000);
        
        console.log('📊 使用统计定期刷新已启动（每30秒）');
      }
      
      // 停止定期刷新
      function stopUsageSync() {
        if (usageRefreshInterval) {
          clearInterval(usageRefreshInterval);
          usageRefreshInterval = null;
          console.log('📊 使用统计定期刷新已停止');
        }
      }
      
      // 页面可见性变化时控制刷新
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          // 页面隐藏时停止刷新
          stopUsageSync();
        } else if (currentUser) {
          // 页面显示时立即刷新一次，然后启动定期刷新
          updateUsageStats();
          startUsageSync();
        }
      });

      // 更新头部实时统计显示（从数据库获取最新数据）
      async function updateHeaderStats() {
        if (!currentUser) return;
        
        try {
          // 直接从数据库获取最新数据
          const response = await fetch('/api/admin/users', {
            headers: { 'X-Admin-Token': 'secret-admin' }
          });
          
          if (response.ok) {
            const users = await response.json();
            const serverUserData = users.find(user => user.id === currentUser.id);
            
            if (serverUserData) {
              // 更新今日使用量
              const todayUsageElement = document.getElementById('todayUsageMini');
              if (todayUsageElement) {
                todayUsageElement.textContent = serverUserData.daily_used || '0';
              }

              // 更新剩余配额
              const remainingQuotaElement = document.getElementById('remainingQuotaMini');
              if (remainingQuotaElement) {
                const remaining = serverUserData.usage_quota ? 
                  (serverUserData.usage_quota - (serverUserData.usage_used || 0)) : '∞';
                remainingQuotaElement.textContent = remaining;

                // 根据配额状态设置样式
                remainingQuotaElement.className = 'stat-value-mini';
                if (serverUserData.usage_quota && remaining <= 0) {
                  remainingQuotaElement.className = 'stat-value-mini error';
                } else if (serverUserData.usage_quota && remaining <= 5) {
                  remainingQuotaElement.className = 'stat-value-mini warning';
                }
              }
            }
          }
        } catch (error) {
          // 如果获取失败，显示错误状态
          console.warn('获取头部统计失败:', error);
          const todayUsageElement = document.getElementById('todayUsageMini');
          const remainingQuotaElement = document.getElementById('remainingQuotaMini');
          if (todayUsageElement) todayUsageElement.textContent = '?';
          if (remainingQuotaElement) remainingQuotaElement.textContent = '?';
        }
      }

      // 增加用户使用次数（纯数据库模式）
      async function incrementUsage() {
        if (!currentUser) return false;
        
        try {
          // 从数据库获取当前使用情况
          const response = await fetch('/api/admin/users', {
            headers: { 'X-Admin-Token': 'secret-admin' }
          });
          
          if (response.ok) {
            const users = await response.json();
            const serverUserData = users.find(user => user.id === currentUser.id);
            
            if (serverUserData) {
              // 检查配额限制（使用数据库中的最新数据）
              if (serverUserData.usage_quota && serverUserData.usage_used >= serverUserData.usage_quota) {
                showWarning('配额已用完\n\n您的使用配额已达到上限，请联系管理员增加配额');
                return false;
              }
              
              // 配额检查通过，返回true让后端处理使用次数增加
              return true;
            }
          }
          
          // 如果无法获取数据，允许继续（后端会处理）
          return true;
        } catch (error) {
          console.warn('检查配额失败:', error);
          // 网络错误时允许继续，后端会处理
          return true;
        }
      }

      // 退出登录
      document.getElementById('btnLogout')?.addEventListener('click', () => {
        stopUsageSync(); // 停止使用统计同步
        currentUser = null;
        localStorage.removeItem('currentUser');
        updateUserUI();
        closeModal(userAccountModal);
        showSuccess('已成功退出登录');
      });

      // 初始化用户状态（纯数据库模式）
      (async function() {
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
          try {
            currentUser = JSON.parse(savedUser);
            await updateUsageStats(); // 从数据库获取最新使用统计
            startUsageSync(); // 启动使用统计同步
          } catch (e) {
            localStorage.removeItem('currentUser');
          }
        }
        updateUserUI();
      })();

      // 管理员令牌验证功能
      function verifyAdminToken() {
        const token = (adminTokenInput?.value || '').trim();
        if (!token) {
          if (adminFunctions) {
            adminFunctions.style.display = 'none';
          }
          return false;
        }
        
        // 验证令牌（这里可以调用后端API验证，目前简单验证）
        if (token === 'secret-admin') {
          if (adminFunctions) {
            adminFunctions.style.display = 'block';
            adminFunctions.classList.add('show');
          }
          
          // 显示验证成功提示
          const hint = document.querySelector('.admin-auth-section .field-hint');
          if (hint) {
            hint.innerHTML = '✅ 令牌验证成功！您现在可以使用所有管理功能';
            hint.style.color = 'var(--success-600)';
          }
          return true;
        } else {
          if (adminFunctions) {
            adminFunctions.style.display = 'none';
            adminFunctions.classList.remove('show');
          }
          
          // 显示验证失败提示
          const hint = document.querySelector('.admin-auth-section .field-hint');
          if (hint) {
            hint.innerHTML = '❌ 令牌验证失败，请输入正确的 ADMIN_TOKEN';
            hint.style.color = 'var(--error-600)';
          }
          return false;
        }
      }

      // 监听令牌输入变化
      adminTokenInput?.addEventListener('input', verifyAdminToken);
      adminTokenInput?.addEventListener('keyup', (e) => {
        if (e.key === 'Enter') {
          verifyAdminToken();
        }
      });

      // 可折叠侧栏分组
      document.querySelectorAll('.group.collapsible .section-head').forEach(head=>{
        head.addEventListener('click', ()=>{
          const parent = head.parentElement;
          parent.classList.toggle('collapsed');
        });
      });
      let imagePreviewUrls = [];
      let messages = [];
      let isAtBottom = true;

      function incCount(){ msgCountEl.textContent = messages.length + ' 条消息'; }

      function addBubble(content, role, imageUrls){
        empty.style.display = 'none';
        const div = document.createElement('div');
        div.className = 'message ' + (role === 'user' ? 'user':'bot');
        
        // 创建图标
        const icon = document.createElement('div');
        icon.className = 'message-icon';
        if(role === 'user'){
          icon.innerHTML = '👤'; // 用户图标
          icon.title = '用户';
        } else {
          icon.innerHTML = '🩺'; // 医生图标
          icon.title = 'AI 诊疗助手';
        }
        div.appendChild(icon);
        
        // 创建内容容器
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        
        if(content){
          if(role==='assistant' || role==='bot'){
            try{
              const html = DOMPurify.sanitize(marked.parse(content||''));
              const md = document.createElement('div'); md.className='md'; md.innerHTML = html; contentDiv.appendChild(md);
            }catch{ contentDiv.innerText = content; }
          }else{
            contentDiv.innerText = content;
          }
        }
        
        if(imageUrls && imageUrls.length){
          const pics = document.createElement('div');
          pics.className = 'bubble-images';
          imageUrls.forEach(src => {
            const im = document.createElement('img');
            im.src = src;
            im.alt = 'uploaded image';
            im.addEventListener('click', ()=> openImageModal(src));
            pics.appendChild(im);
          });
          contentDiv.appendChild(pics);
        }
        
        div.appendChild(contentDiv);
        
        if(role !== 'user' && content){ try{ attachTts(contentDiv, content); }catch{} }
        chat.appendChild(div);
        if(isAtBottom) chat.scrollTop = chat.scrollHeight;
        messages.push({ role, content });
        incCount();
      }

      async function toBase64(file){
        return new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onload = () => resolve(r.result.split(',')[1]);
          r.onerror = reject;
          r.readAsDataURL(file);
        });
      }

      function addThumb(src){
        const box = document.createElement('div');
        box.className = 'thumb';
        const img = document.createElement('img');
        img.src = src;
        img.title = '点击预览';
        img.style.cursor = 'zoom-in';
        img.addEventListener('click', ()=> openImageModal(src));
        box.appendChild(img);
        const rm = document.createElement('div'); rm.className='rm'; rm.textContent='×';
        rm.addEventListener('click', ()=>{
          const idx=[...gallery.children].indexOf(box);
          imagesBase64.splice(idx,1);
          imagePreviewUrls.splice(idx,1);
          box.remove();
          toggleSendEnable();
        });
        box.appendChild(rm);
        gallery.appendChild(box);
      }

      const allowedTypes = ['image/jpeg','image/png','image/gif','image/webp','image/bmp'];
      const maxSize = 5 * 1024 * 1024;
      async function handleFiles(fs){
        for(const f of fs){
          if(!allowedTypes.includes(f.type)){ showWarning('不支持的文件格式\n\n仅支持以下格式：\n• JPEG/JPG\n• PNG\n• GIF\n• WebP\n• BMP'); continue; }
          if(f.size>maxSize){ showWarning('图片文件过大\n\n请选择小于 5MB 的图片文件'); continue; }
          const b64 = await toBase64(f);
          imagesBase64.push(b64);
          const url = URL.createObjectURL(f);
          imagePreviewUrls.push(url);
          addThumb(url);
        }
        toggleSendEnable();
      }

      // Drag & drop
      ;['dragenter','dragover','dragleave','drop'].forEach(ev => { dropArea.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }); });
      ;['dragenter','dragover','dragleave','drop'].forEach(ev => { document.addEventListener(ev, e => { if(e.target===document || e.target===document.body){ e.preventDefault(); } }); });
      document.addEventListener('drop', async e => { if(e.target===document || e.target===document.body){ await handleFiles(e.dataTransfer.files); }});
      // 全局防止浏览器打开文件，增强稳定性
      window.addEventListener('dragover', e => e.preventDefault());
      window.addEventListener('drop', e => { if(e.target===window){ e.preventDefault(); }});
      // 滚动状态
      chat.addEventListener('scroll', ()=>{
        const threshold = 40;
        isAtBottom = chat.scrollTop + chat.clientHeight >= chat.scrollHeight - threshold;
      });
      dropArea.addEventListener('drop', async e => {
        const files = e.dataTransfer.files;
        await handleFiles(files);
      });

      pickImgBtn.addEventListener('click', () => fileEl.click());
      fileEl.addEventListener('change', async () => {
        await handleFiles(fileEl.files);
        fileEl.value = '';
      });

      function toggleSendEnable(){
        const hasText = !!promptEl.value.trim();
        const hasImg = imagesBase64.length>0;
        const enabled = hasText || hasImg;
        sendBtn.setAttribute('aria-disabled', String(!enabled));
        inputImages.style.display = hasImg ? '' : 'none';
      }

      promptEl.addEventListener('input', ()=>{
        promptEl.style.height='auto';
        promptEl.style.height = Math.min(promptEl.scrollHeight, 200) + 'px';
        toggleSendEnable();
      });

      async function send(){
        const prompt = promptEl.value.trim();
        if(!prompt && imagesBase64.length===0){ promptEl.focus(); return; }
        // 在用户气泡中内联显示所选图片预览
        addBubble(prompt, 'user', imagePreviewUrls.slice());
        sendBtn.style.opacity = .6; sendBtn.style.pointerEvents='none';
        try{
          const payload = {
            model: modelEl.value,
            prompt,
            images: imagesBase64.length ? imagesBase64 : undefined,
            stream: true
          };
          const headers = {'Content-Type':'application/json'};
          // 优先使用当前登录用户的ID，如果没有登录则使用手动输入的ID
          // 自动修复：currentUser为null时也用默认ID
          const uid = currentUser ? currentUser.id : (userIdInput.value||'4').trim();
          if(uid) headers['X-User-Id'] = uid;
          const res = await fetch('/api/generate', { method:'POST', headers, body:JSON.stringify(payload) });
          if(!res.ok){ addBubble('错误: HTTP '+res.status+'\n'+await res.text(),'bot'); return; }

          // 流式渲染
          const botDiv = document.createElement('div');
          botDiv.className = 'message bot mono md';
          
          // 创建助手图标
          const botIcon = document.createElement('div');
          botIcon.className = 'message-icon';
          botIcon.innerHTML = '🩺'; // 医生图标
          botIcon.title = 'AI 诊疗助手';
          botDiv.appendChild(botIcon);
          
          // 创建内容容器
          const botContentDiv = document.createElement('div');
          botContentDiv.className = 'message-content';
          botDiv.appendChild(botContentDiv);
          
          chat.appendChild(botDiv);
          chat.scrollTop = chat.scrollHeight;
          messages.push({ role:'assistant', content:'' });
          incCount();

          const reader = res.body.getReader();
          const decoder = new TextDecoder();
          let buffer = '';
          const cursor = document.createElement('span'); cursor.className = 'cursor'; botContentDiv.appendChild(cursor);
          while(true){
            const { value, done } = await reader.read();
            if(done) break;
            buffer += decoder.decode(value, { stream:true });
            // 处理多种可能：SSE 的 data: 行 或 直接 JSON 行
            const parts = buffer.split('\n');
            buffer = parts.pop();
            for(const line of parts){
              const l = line.trim();
              if(!l) continue;
              let text = '';
              if(l.startsWith('data:')){
                const raw = l.slice(5).trim();
                try{
                  const obj = JSON.parse(raw);
                  text = obj.response ?? obj.message ?? '';
                }catch{ text = raw; }
              }else{
                try{
                  const obj = JSON.parse(l);
                  text = obj.response ?? obj.message ?? '';
                }catch{ text = l; }
              }
              // 增量渲染
              cursor.remove();
              const prev = messages[messages.length-1].content || '';
              const next = prev + text;
              messages[messages.length-1].content = next;
              try{
                const html = DOMPurify.sanitize(marked.parse(next));
                botContentDiv.innerHTML = html;
                botContentDiv.appendChild(cursor);
              }catch{
                botContentDiv.textContent = next;
                botContentDiv.appendChild(cursor);
              }
              chat.scrollTop = chat.scrollHeight;
            }
          }
          cursor.remove();
          const speakText = messages[messages.length-1].content || '';
          const tip = document.createElement('div');
          tip.className = 'hint';
          tip.textContent = '免责声明：本内容由AI生成，仅供参考，不能替代专业医生的诊断与治疗建议。若有不适请及时就医。';
          botContentDiv.appendChild(tip);
          try{ attachTts(botContentDiv, speakText); }catch{}
          
          // AI响应成功后，静默刷新使用统计（从数据库获取最新数据）
          setTimeout(async () => {
            await updateUsageStats();
            // 移除弹窗通知，改为后台静默更新
          }, 1000);
        }catch(err){
          addBubble('请求异常：'+err, 'bot');
        }finally{
          sendBtn.style.opacity = 1; sendBtn.style.pointerEvents='auto';
          promptEl.value = '';
          promptEl.style.height='auto';
          // 清空已选择图片
          imagesBase64 = [];
          imagePreviewUrls = [];
          gallery.innerHTML = '';
          toggleSendEnable();
        }
      }

      sendBtn.addEventListener('click', ()=>{ if(sendBtn.getAttribute('aria-disabled')==='false') send(); });
      promptEl.addEventListener('keydown', e => { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); if(sendBtn.getAttribute('aria-disabled')==='false') send(); }});

      btnNew.addEventListener('click', () => { saveCurrentSession(); startNewSession(); });

      // 替换导出为txt（包含日期与标题）
      btnExport.addEventListener('click', () => {
        const lines = ['AI 医疗诊断助手对话报告', new Date().toLocaleString(), ''];
        messages.forEach(m => { lines.push((m.role==='user'?'[用户] ':'[助手] ')+m.content); lines.push(''); });
        const blob = new Blob([lines.join('\n')], {type:'text/plain'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = '对话报告.txt'; a.click();
      });

      // 历史会话：打开模态框
      btnHistory.addEventListener('click', openHistoryModal);

      // 历史与会话持久化
      const LS_KEY = 'medd_history';
      const SS_CUR = 'medd_current';
      const LS_PROMPTS = 'medd_presets';

      function saveCurrentSession(){
        if(messages.length===0) return;
        const hist = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
        const titleMsg = messages.find(m=>m.role==='user');
        const title = titleMsg ? (titleMsg.content.slice(0,30) || '新会话') : '新会话';
        const id = sessionStorage.getItem(SS_CUR) || String(Date.now());
        const item = { id, title, time: new Date().toISOString(), messages };
        const remain = hist.filter(x=>x.id!==id);
        remain.unshift(item);
        localStorage.setItem(LS_KEY, JSON.stringify(remain.slice(0,100)));
      }

      function startNewSession(){
        const id = String(Date.now());
        sessionStorage.setItem(SS_CUR, id);
        chat.innerHTML=''; gallery.innerHTML=''; imagesBase64=[]; imagePreviewUrls=[]; messages=[]; incCount(); empty.style.display=''; inputImages.style.display='none';
      }

      function openHistoryModal(){
        // 统一行为：窄屏先收起侧边栏
        collapseSideIfNarrow();
        const hist = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
        const m = document.createElement('div'); m.className='modal';
        const card = document.createElement('div'); card.className='history-modal-card'; m.appendChild(card);
        
        // 右上角关闭按钮
        const closeBtn = document.createElement('button'); 
        closeBtn.className='history-close-btn'; 
        closeBtn.innerHTML='×'; 
        closeBtn.title='关闭';
        closeBtn.addEventListener('click', ()=> document.body.removeChild(m));
        card.appendChild(closeBtn);
        
        // 标题
        const h3 = document.createElement('h3'); 
        h3.textContent='历史会话'; 
        h3.style.marginRight='40px'; // 为关闭按钮留出空间
        card.appendChild(h3);
        
        // 历史列表
        const list = document.createElement('div'); list.className='list'; card.appendChild(list);
        hist.forEach(item=>{
          const row = document.createElement('div'); row.className='item';
          const left = document.createElement('div'); left.textContent = `${item.title} · ${new Date(item.time).toLocaleString()}`; row.appendChild(left);
          const acts = document.createElement('div'); acts.className='actions';
          const load = document.createElement('div'); load.className='iconbtn'; load.title='加载'; load.textContent='📂';
          const del = document.createElement('div'); del.className='iconbtn'; del.title='删除'; del.textContent='🗑️';
          acts.appendChild(load); acts.appendChild(del); row.appendChild(acts);
          list.appendChild(row);
          load.addEventListener('click', ()=>{ messages=item.messages; chat.innerHTML=''; gallery.innerHTML=''; inputImages.style.display='none'; empty.style.display='none'; messages.forEach(msg=> addBubble(msg.content, msg.role)); sessionStorage.setItem(SS_CUR, item.id); document.body.removeChild(m); });
          del.addEventListener('click', ()=>{ if(confirm('确定删除该会话吗？')){ const remain = hist.filter(x=>x.id!==item.id); localStorage.setItem(LS_KEY, JSON.stringify(remain)); document.body.removeChild(m); }});
        });
        
        // 点击背景关闭
        m.addEventListener('click', (e)=>{ if(e.target===m) document.body.removeChild(m); });
        document.body.appendChild(m);
      }

      // 页面初始化：恢复当前会话
      (function(){
        const id = sessionStorage.getItem(SS_CUR);
        if(id){
          const hist = JSON.parse(localStorage.getItem(LS_KEY) || '[]');
          const item = hist.find(x=>x.id===id);
          if(item){ messages=item.messages||[]; empty.style.display='none'; messages.forEach(msg=> addBubble(msg.content, msg.role)); }
        }else{ sessionStorage.setItem(SS_CUR, String(Date.now())); }
      })();

      // 图片预览模态框
      function openImageModal(src){
        const m = document.createElement('div'); m.className='modal';
        const card = document.createElement('div'); card.className='image-modal-card'; m.appendChild(card);
        
        // 右上角关闭按钮
        const closeBtn = document.createElement('button'); 
        closeBtn.className='image-close-btn'; 
        closeBtn.innerHTML='×'; 
        closeBtn.title='关闭';
        closeBtn.addEventListener('click', ()=> document.body.removeChild(m));
        card.appendChild(closeBtn);
        
        // 标题
        const h3 = document.createElement('h3'); 
        h3.textContent='图片预览'; 
        h3.style.marginRight='40px'; // 为关闭按钮留出空间
        card.appendChild(h3);
        
        // 图片
        const img = document.createElement('img'); 
        img.src = src; 
        img.style.maxWidth='90vw'; 
        img.style.maxHeight='70vh'; 
        img.style.display='block'; 
        img.style.margin='0 auto'; 
        img.style.borderRadius='12px';
        img.style.boxShadow='var(--shadow-lg)';
        card.appendChild(img);
        
        // 点击背景关闭
        m.addEventListener('click', (e)=>{ if(e.target===m) document.body.removeChild(m); });
        document.body.appendChild(m);
      }

      // 预设提示词：增删插入
      function loadPresets(){
        try{
          const raw = localStorage.getItem(LS_PROMPTS);
          if(raw){
            const arr = JSON.parse(raw);
            if(Array.isArray(arr)) return arr;
          }
        }catch{}
        const defaults = [
          { id: String(Date.now()-3), title: '结构化病史采集', text: '请按“主诉-现病史-既往史-过敏史-用药史-家族史-个人史-体格检查-辅助检查-初步诊断-鉴别诊断-处理建议”结构化输出。' },
          { id: String(Date.now()-2), title: '影像判读模板', text: '请逐项描述影像所见：部位、大小、形态、边界、密度/信号、强化特征，并给出可能诊断及依据。最后建议进一步检查。' },
          { id: String(Date.now()-1), title: '用词规范提醒', text: '回答需谨慎保守，避免绝对化表述。对不确定结论说明不确定性，并建议至相应专科就诊。' }
        ];
        localStorage.setItem(LS_PROMPTS, JSON.stringify(defaults));
        return defaults;
      }

      function savePresets(list){
        localStorage.setItem(LS_PROMPTS, JSON.stringify(list));
      }

      function openPresetsModal(){
        const presets = loadPresets();
        const m = document.createElement('div'); m.className='modal';
        const card = document.createElement('div'); card.className='modal-card'; m.appendChild(card);
        card.style.position='relative';
        const h3 = document.createElement('h3'); h3.textContent='预设提示词'; card.appendChild(h3);
        // 右上角关闭
        const closeX = document.createElement('div');
        closeX.className = 'iconbtn';
        closeX.title = '关闭';
        closeX.textContent = '✕';
        closeX.style.position='absolute';
        closeX.style.top='10px';
        closeX.style.right='10px';
        closeX.addEventListener('click', ()=> document.body.removeChild(m));
        card.appendChild(closeX);

        // 新增区域
        const addBox = document.createElement('div'); addBox.style.marginBottom='12px'; addBox.style.display='grid'; addBox.style.gap='8px';
        const titleInput = document.createElement('input'); titleInput.placeholder='标题（如：影像判读模板）'; titleInput.style.padding='8px 10px'; titleInput.style.border='1px solid var(--line)'; titleInput.style.borderRadius='8px';
        const textInput = document.createElement('textarea'); textInput.rows=4; textInput.placeholder='提示词内容'; textInput.style.padding='8px 10px'; textInput.style.border='1px solid var(--line)'; textInput.style.borderRadius='8px';
        const addBtn = document.createElement('button'); addBtn.textContent='新增预设'; addBtn.className='btn';
        addBtn.addEventListener('click', ()=>{
          const t = (titleInput.value||'').trim();
          const txt = (textInput.value||'').trim();
          if(!txt){ showWarning('预设内容不能为空\n\n请输入预设文本内容'); return; }
          const list = loadPresets();
          list.unshift({ id:String(Date.now()), title: t||'未命名预设', text: txt });
          savePresets(list);
          document.body.removeChild(m);
          openPresetsModal();
        });
        addBox.appendChild(titleInput); addBox.appendChild(textInput); addBox.appendChild(addBtn); card.appendChild(addBox);

        // 列表
        const list = document.createElement('div'); list.className='list'; card.appendChild(list);
        const renderItem = (item)=>{
          const row = document.createElement('div'); row.className='item';
          const left = document.createElement('div');
          left.style.display='grid'; left.style.gap='4px';
          const tt = document.createElement('div'); tt.style.fontWeight='600'; tt.textContent=item.title||'未命名预设';
          const preview = document.createElement('div'); preview.className='hint'; preview.textContent = (item.text||'').slice(0,80) + ((item.text||'').length>80?'...':'');
          left.appendChild(tt); left.appendChild(preview);
          const acts = document.createElement('div'); acts.className='actions';
          const use = document.createElement('div'); use.className='iconbtn'; use.title='插入'; use.textContent='📥';
          const del = document.createElement('div'); del.className='iconbtn'; del.title='删除'; del.textContent='🗑️';
          acts.appendChild(use); acts.appendChild(del);
          row.appendChild(left); row.appendChild(acts);
          list.appendChild(row);

          use.addEventListener('click', ()=>{
            const text = item.text||'';
            const cur = promptEl.value;
            promptEl.value = cur ? (cur.replace(/\s*$/,'') + '\n' + text) : text;
            promptEl.dispatchEvent(new Event('input'));
            document.body.removeChild(m);
            promptEl.focus();
          });
          del.addEventListener('click', ()=>{
            if(!confirm('确定删除该预设吗？')) return;
            const remain = loadPresets().filter(x=>x.id!==item.id);
            savePresets(remain);
            document.body.removeChild(m);
            openPresetsModal();
          });
        };
        presets.forEach(renderItem);

        m.addEventListener('click', (e)=>{ if(e.target===m) document.body.removeChild(m); });
        document.body.appendChild(m);
      }

      btnPresetsIcon.addEventListener('click', openPresetsModal);
      // 注册功能
      document.getElementById('btnDoRegister')?.addEventListener('click', async () => {
        try {
          const body = {
            name: document.getElementById('regName').value.trim(),
            organization: document.getElementById('regOrg').value.trim(),
            phone: document.getElementById('regPhone').value.trim(),
            email: document.getElementById('regEmail').value.trim(),
            password: document.getElementById('regPassword').value.trim()
          };
          
          if (!body.name || !body.email || !body.password) {
            showWarning('注册信息不完整\n\n请填写以下必要信息：\n• 真实姓名\n• 邮箱地址\n• 登录密码');
            return;
          }
          
          const res = await fetch('/api/users/register', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(body)
          });
          
          const data = await res.json();
          if (!res.ok) { 
            showError('用户注册失败', data?.detail || '服务器错误 ' + res.status); 
            return; 
          }
          
          showSuccess('用户注册成功！\n\n请使用您的邮箱和密码登录系统');
          // 切换到登录标签
          document.querySelector('.tab-btn[data-tab="login"]').click();
          document.getElementById('loginEmail').value = body.email;
        } catch (e) { 
          showError('注册系统异常', e.toString()); 
        }
      });

      // 登录功能
      document.getElementById('btnDoLogin')?.addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value.trim();
        const password = document.getElementById('loginPassword').value.trim();
        
        if (!email || !password) {
          showWarning('登录信息不完整\n\n请输入邮箱地址和密码');
          return;
        }
        
        try {
          // 🔐 安全的管理员权限验证系统
          
          // 1. 预设的管理员账户（实际项目中应存储在数据库中，密码应加密）
          const predefinedAdmins = [
            { 
              email: 'admin@medgemma.com', 
              password: 'SecureAdmin2024!', 
              name: '系统管理员',
              id: 1
            },
            { 
              email: 'manager@hospital.com', 
              password: 'HospitalManager123!', 
              name: '医院管理员',
              id: 2
            }
          ];
          
          // 2. 检查是否为预设管理员（严格匹配邮箱和密码）
          const adminUser = predefinedAdmins.find(admin => 
            admin.email === email && admin.password === password
          );
          
          if (adminUser) {
            // ✅ 管理员登录成功，从数据库获取真实使用数据
            try {
              // 从管理员用户列表API获取真实数据
              const adminResponse = await fetch('/api/admin/users', {
                headers: { 'X-Admin-Token': 'secret-admin' }
              });
              
              if (adminResponse.ok) {
                const adminUsers = await adminResponse.json();
                const realAdminData = adminUsers.find(user => user.email === email);
                
                if (realAdminData) {
                  // 只保存基本的用户身份信息，使用统计数据从数据库实时获取
                  const userData = {
                    id: realAdminData.id,
                    email: realAdminData.email,
                    name: realAdminData.name,
                    organization: realAdminData.organization || '系统管理部门',
                    phone: realAdminData.phone || '400-****-0000',
                    is_admin: true,
                    login_time: new Date().toISOString()
                  };
                  
                  currentUser = userData;
                  localStorage.setItem('currentUser', JSON.stringify(userData));
                  updateUserUI();
                  await updateUsageStats(); // 从数据库获取最新使用统计
                  startUsageSync(); // 启动使用统计同步
                  closeModal(loginModal);
                  showSuccess('🎉 管理员登录成功！\n\n欢迎使用 MedGemma AI 管理控制台\n您拥有完整的系统管理权限');
                  return;
                }
              }
            } catch (e) {
              console.warn('获取管理员真实数据失败，使用默认数据:', e);
            }
            
            // 备用方案：只保存基本身份信息
            const userData = {
              id: adminUser.id,
              email: adminUser.email,
              name: adminUser.name,
              organization: '系统管理部门',
              phone: '400-****-0000',
              is_admin: true,
              login_time: new Date().toISOString()
            };
            
            currentUser = userData;
            localStorage.setItem('currentUser', JSON.stringify(userData));
            updateUserUI();
            await updateUsageStats(); // 从数据库获取最新使用统计
            startUsageSync(); // 启动使用统计同步
            closeModal(loginModal);
            showSuccess('🎉 管理员登录成功！\n\n欢迎使用 MedGemma AI 管理控制台\n您拥有完整的系统管理权限');
            return;
          }
          
          // 3. 尝试调用后端API进行普通用户验证
          try {
            const loginResponse = await fetch('/api/users/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email, password })
            });
            
            if (loginResponse.ok) {
              const userData = await loginResponse.json();
              // 只保存基本的用户身份信息，使用统计数据从数据库实时获取
              const basicUserData = {
                id: userData.id,
                email: userData.email,
                name: userData.name,
                organization: userData.organization,
                phone: userData.phone,
                is_admin: userData.is_admin || false,
                login_time: new Date().toISOString()
              };
              
              currentUser = basicUserData;
              localStorage.setItem('currentUser', JSON.stringify(basicUserData));
              updateUserUI();
              await updateUsageStats(); // 从数据库获取最新使用统计
              startUsageSync(); // 启动使用统计同步
              closeModal(loginModal);
              showSuccess('登录成功！\n\n欢迎使用 MedGemma AI 智能诊疗助手\n开始您的专业医疗咨询之旅');
              return;
            } else {
              const errorData = await loginResponse.json();
              showError('用户登录失败', errorData.detail || '邮箱或密码错误，请检查后重试');
              return;
            }
          } catch (apiError) {
            console.warn('后端API不可用，使用演示模式');
          }
          
          // 4. 演示模式：仅用于开发测试（生产环境应移除）
          if (email === 'demo@test.com' && password === 'demo123') {
            // 演示模式也只保存基本身份信息
            const userData = {
              id: Math.floor(Math.random() * 1000) + 100,
              email: email,
              name: '演示用户',
              organization: '演示机构',
              phone: '138****8888',
              is_admin: false, // 演示用户不具备管理员权限
              login_time: new Date().toISOString()
            };
            
            currentUser = userData;
            localStorage.setItem('currentUser', JSON.stringify(userData));
            updateUserUI();
            await updateUsageStats(); // 从数据库获取最新使用统计
            startUsageSync(); // 启动使用统计同步
            closeModal(loginModal);
            showInfo('演示登录成功！\n\n🚨 注意：这是演示模式\n\n可用账户：\n• 管理员：admin@medgemma.com / SecureAdmin2024!\n• 普通用户：demo@test.com / demo123\n\n演示模式功能有限，建议使用真实账户');
            return;
          }
          
          // 5. 登录失败
          showError('登录失败：邮箱或密码错误\n\n💡 登录提示：\n• 管理员请使用预设账户\n• 普通用户请先注册或联系管理员\n• 确认邮箱和密码输入正确');
          
        } catch (e) {
          console.error('登录异常:', e);
          showError('登录系统异常', '系统暂时无法处理登录请求，请稍后重试');
        }
      });
      // 修改密码功能
      document.getElementById('btnChangePassword')?.addEventListener('click', async () => {
        if (!currentUser) {
          showWarning('请先登录系统\n\n修改密码需要先登录您的账户');
          return;
        }
        
        const oldPassword = prompt('请输入当前密码：');
        const newPassword = prompt('请输入新密码（至少6位）：');
        if (!oldPassword || !newPassword) {
          return;
        }
        
        if (newPassword.length < 6) {
          showWarning('密码强度不足\n\n新密码至少需要6位字符，建议包含字母、数字和特殊字符');
          return;
        }
        
        try {
          const res = await fetch(`/api/users/${currentUser.id}/password:change`, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ 
              old_password: oldPassword, 
              new_password: newPassword 
            })
          });
          
          const data = await res.json();
          if (!res.ok) { 
            showError('密码修改失败', data?.detail || '服务器错误 ' + res.status); 
            return; 
          }
          
          showSuccess('密码修改成功！\n\n您的账户密码已更新，下次登录请使用新密码');
        } catch (e) { 
          showError('密码修改异常', e.toString()); 
        }
      });
      // 管理员：列出用户 - 弹窗列表显示
      btnListUsers.addEventListener('click', async ()=>{
        const tok = (adminTokenInput.value||'').trim(); 
        if(!tok){ 
          showWarning('管理员令牌验证\n\n请先输入管理员令牌以验证身份'); 
          return; 
        }
        
        try{
          const res = await fetch('/api/admin/users', { headers:{ 'X-Admin-Token': tok } });
          const data = await res.json();
          if(!res.ok){ 
            showError('获取用户列表失败', data?.detail || '服务器错误 ' + res.status); 
            return; 
          }
          
          // 创建增强的用户管理弹窗
          showEnhancedUserManagement(data);
        }catch(e){ 
          showError('请求异常', e.toString()); 
        }
      });
      // 管理员：设定配额（总+日）
      btnSetQuota.addEventListener('click', async ()=>{
        const tok = (adminTokenInput.value||'').trim(); if(!tok){ showWarning('请先填写管理员令牌'); return; }
        const uid = (userIdInput.value||'').trim(); if(!uid){ showWarning('请先填写用户ID'); return; }
        const qv = quotaInput.value.trim(); const dqv = dailyQuotaInput.value.trim();
        const quota = qv==='' ? null : Number(qv);
        const daily_quota = dqv==='' ? null : Number(dqv);
        try{
          const res = await fetch(`/api/admin/users/${encodeURIComponent(uid)}`, { method:'PATCH', headers:{ 'X-Admin-Token': tok, 'Content-Type':'application/json' }, body: JSON.stringify({ usage_quota: quota, daily_quota }) });
          const data = await res.json();
          if(!res.ok){ showError('配额设置失败', data?.detail || '服务器错误 ' + res.status); return; }
          showSuccess('配额设置成功！', data);
        }catch(e){ showError('配额设置异常', e.toString()); }
      });
      // 管理员：重置用量
      btnResetUsage.addEventListener('click', async ()=>{
        const tok = (adminTokenInput.value||'').trim(); if(!tok){ showWarning('请先填写管理员令牌'); return; }
        const uid = (userIdInput.value||'').trim(); if(!uid){ showWarning('请先填写用户ID'); return; }
        
        showConfirm('确认重置用户用量？\n\n此操作将清空用户的使用记录，无法恢复', async () => {
        try{
          const res = await fetch(`/api/admin/users/${encodeURIComponent(uid)}:reset-usage`, { method:'POST', headers:{ 'X-Admin-Token': tok } });
          const data = await res.json();
            if(!res.ok){ showError('重置用量失败', data?.detail || '服务器错误 ' + res.status); return; }
            showSuccess('用户用量已重置', '用户的使用统计已清零');
          }catch(e){ showError('重置用量异常', e.toString()); }
        });
      });
      // 管理员：导出CSV
      btnExportCsv.addEventListener('click', async ()=>{
        const tok = (adminTokenInput.value||'').trim(); if(!tok){ showWarning('请先填写管理员令牌'); return; }
        try{
          const res = await fetch('/api/admin/users:export-csv', { headers:{ 'X-Admin-Token': tok } });
          const text = await res.text();
          if(!res.ok){ showError('CSV导出失败', '服务器错误 ' + res.status); return; }
          const blob = new Blob([text], { type:'text/csv;charset=utf-8' });
          const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'users.csv'; a.click();
          showSuccess('CSV文件导出成功！\n\n用户数据已下载到本地，文件名：users.csv');
        }catch(e){ showError('CSV导出异常', e.toString()); }
      });
      // 管理员：导入CSV按钮点击触发文件选择
      btnImportCsv.addEventListener('click', async ()=>{
        const tok = (adminTokenInput.value||'').trim(); 
        if(!tok){ showWarning('请先填写管理员令牌'); return; }
        csvFile.click(); // 触发文件选择
      });

      // 管理员：CSV文件选择后执行导入
      csvFile.addEventListener('change', async ()=>{
        const tok = (adminTokenInput.value||'').trim(); 
        if(!tok){ showWarning('请先填写管理员令牌'); return; }
        const f = csvFile.files && csvFile.files[0]; 
        if(!f){ return; }
        
        showConfirm(`确认导入CSV文件？\n\n文件名：${f.name}\n文件大小：${(f.size/1024).toFixed(2)} KB\n\n此操作将更新用户数据`, async () => {
        try{
          const fd = new FormData(); fd.append('file', f);
          const res = await fetch('/api/admin/users:import-csv', { method:'POST', headers:{ 'X-Admin-Token': tok }, body: fd });
          const data = await res.json();
            if(!res.ok){ showError('CSV导入失败', data?.detail || '服务器错误 ' + res.status); return; }
            showSuccess('CSV文件导入成功！', `成功导入 ${data.imported} 条用户记录`);
            csvFile.value = ''; // 清空文件选择
          }catch(e){ showError('CSV导入异常', e.toString()); }
        });
      });
      // 管理员：用量汇总
      btnUsageSummary.addEventListener('click', async ()=>{
        const tok = (adminTokenInput.value||'').trim(); if(!tok){ showWarning('请先填写管理员令牌'); return; }
        const qs = new URLSearchParams();
        const s = (startInput.value||'').trim(); const e = (endInput.value||'').trim();
        if(s) qs.set('start', s); if(e) qs.set('end', e);
        try{
          const res = await fetch('/api/admin/usage:summary?'+qs.toString(), { headers:{ 'X-Admin-Token': tok } });
          const data = await res.json();
          if(!res.ok){ showError('用量汇总失败', data?.detail || '服务器错误 ' + res.status); return; }
          
          // 显示专业的汇总数据表格
          showDataTable({
            title: '📊 系统用量汇总',
            message: `时间范围: ${data.window?.start || '不限'} 至 ${data.window?.end || '不限'}`,
            data: [
              { 指标: '总事件数', 数值: data.total_events, 单位: '次' },
              { 指标: '查询开始时间', 数值: data.window?.start || '不限', 单位: '-' },
              { 指标: '查询结束时间', 数值: data.window?.end || '不限', 单位: '-' },
              { 指标: '统计生成时间', 数值: new Date().toLocaleString(), 单位: '-' }
            ],
            columns: [
              { key: '指标', label: '统计指标', align: 'left' },
              { key: '数值', label: '统计数值', align: 'right' },
              { key: '单位', label: '单位', align: 'center' }
            ],
            width: '600px'
          });
        }catch(e){ showError('用量汇总异常', e.toString()); }
      });
      // 管理员：按用户汇总 -> 图表和表格
      btnUsageByUser.addEventListener('click', async ()=>{
        const tok = (adminTokenInput.value||'').trim(); if(!tok){ showWarning('请先填写管理员令牌'); return; }
        const qs = new URLSearchParams();
        const s = (startInput.value||'').trim(); const e = (endInput.value||'').trim();
        if(s) qs.set('start', s); if(e) qs.set('end', e);
        try{
          const res = await fetch('/api/admin/usage:by-user?'+qs.toString(), { headers:{ 'X-Admin-Token': tok } });
          const arr = await res.json();
          if(!res.ok){ showError('按用户统计失败', arr?.detail || '服务器错误 ' + res.status); return; }
          
          // 显示图表
          const top = arr.slice(0, 10);
          const labels = top.map(x=> '用户'+x.user_id);
          const values = top.map(x=> x.count);
          renderLineChart('usageChartUser', labels, values);
          
          // 显示详细的用户使用统计表格
          showDataTable({
            title: '👥 用户使用统计 (Top 20)',
            message: `时间范围: ${s || '不限'} 至 ${e || '不限'}`,
            data: arr.slice(0, 20).map((item, index) => ({
              排名: index + 1,
              用户ID: item.user_id,
              使用次数: item.count,
              占比: ((item.count / arr.reduce((sum, x) => sum + x.count, 0)) * 100).toFixed(2) + '%'
            })),
            columns: [
              { key: '排名', label: '排名', align: 'center' },
              { key: '用户ID', label: '用户ID', align: 'left' },
              { key: '使用次数', label: '使用次数', align: 'right' },
              { key: '占比', label: '占比', align: 'right' }
            ],
            width: '700px'
          });
        }catch(e){ showError('按用户统计异常', e.toString()); }
      });
      // 管理员：按日期汇总 -> 图表和表格
      btnUsageByDay.addEventListener('click', async ()=>{
        const tok = (adminTokenInput.value||'').trim(); if(!tok){ showWarning('请先填写管理员令牌'); return; }
        const qs = new URLSearchParams();
        const s = (startInput.value||'').trim(); const e = (endInput.value||'').trim();
        if(s) qs.set('start', s); if(e) qs.set('end', e);
        try{
          const res = await fetch('/api/admin/usage:by-day?'+qs.toString(), { headers:{ 'X-Admin-Token': tok } });
          const arr = await res.json();
          if(!res.ok){ showError('按日期统计失败', arr?.detail || '服务器错误 ' + res.status); return; }
          
          // 显示图表
          const labels = arr.map(x=> x.date);
          const values = arr.map(x=> x.count);
          renderLineChart('usageChartDay', labels, values);
          
          // 显示详细的日期使用统计表格
          const totalUsage = arr.reduce((sum, x) => sum + x.count, 0);
          const avgUsage = totalUsage / arr.length;
          
          showDataTable({
            title: '📅 日期使用统计',
            message: `时间范围: ${s || '不限'} 至 ${e || '不限'} | 总使用量: ${totalUsage} 次 | 日均使用: ${avgUsage.toFixed(2)} 次`,
            data: arr.map(item => ({
              日期: item.date,
              使用次数: item.count,
              相对平均值: item.count > avgUsage ? `+${(item.count - avgUsage).toFixed(0)}` : `${(item.count - avgUsage).toFixed(0)}`,
              占比: ((item.count / totalUsage) * 100).toFixed(2) + '%'
            })),
            columns: [
              { key: '日期', label: '日期', align: 'left' },
              { key: '使用次数', label: '使用次数', align: 'right' },
              { key: '相对平均值', label: '相对平均值', align: 'right' },
              { key: '占比', label: '占比', align: 'right' }
            ],
            width: '700px'
          });
        }catch(e){ showError('按日期统计异常', e.toString()); }
      });
      // 管理员：分页用户列表
      btnPaged2.addEventListener('click', async ()=>{
        const tok = (adminTokenInput.value||'').trim(); if(!tok){ showWarning('请先填写管理员令牌'); return; }
        try{
          const res = await fetch('/api/admin/users:paged2?page=1&size=10&sort=id&order=asc', { headers:{ 'X-Admin-Token': tok } });
          const data = await res.json();
          if(!res.ok){ showError('分页查询失败', data?.detail || '服务器错误 ' + res.status); return; }
          
          // 显示分页用户列表表格
          showDataTable({
            title: '📄 分页用户列表 (第1页)',
            message: `总用户数: ${data.total} 位 | 每页显示: 10 位 | 排序: ID升序`,
            data: (data.items || []).map(user => ({
              用户ID: user.id,
              邮箱: user.email,
              姓名: user.name || '-',
              机构: user.organization || '-',
              管理员: user.is_admin ? '是' : '否',
              配额: user.usage_quota === null ? '无限制' : user.usage_quota,
              已用: user.usage_used || 0,
              状态: user.status === 'active' ? '活跃' : '禁用'
            })),
            columns: [
              { key: '用户ID', label: 'ID', align: 'center' },
              { key: '邮箱', label: '邮箱', align: 'left' },
              { key: '姓名', label: '姓名', align: 'left' },
              { key: '机构', label: '机构', align: 'left' },
              { key: '管理员', label: '管理员', align: 'center' },
              { key: '配额', label: '配额', align: 'right' },
              { key: '已用', label: '已用', align: 'right' },
              { key: '状态', label: '状态', align: 'center' }
            ],
            width: '1000px'
          });
        }catch(e){ showError('分页查询异常', e.toString()); }
      });
      // 管理员：搜索用户
      btnSearchUsers.addEventListener('click', async ()=>{
        const tok = (adminTokenInput.value||'').trim(); if(!tok){ showWarning('请先填写管理员令牌'); return; }
        const q = (searchInput.value||'').trim();
        if (!q) { showWarning('请输入搜索关键词'); return; }
        
        try{
          const res = await fetch('/api/admin/users:search?q='+encodeURIComponent(q), { headers:{ 'X-Admin-Token': tok } });
          const data = await res.json();
          if(!res.ok){ showError('用户搜索失败', data?.detail || '服务器错误 ' + res.status); return; }
          
          // 显示搜索结果表格
          showDataTable({
            title: '🔍 用户搜索结果',
            message: `搜索关键词: "${q}" | 找到 ${data.length} 位用户`,
            data: data.map(user => ({
              用户ID: user.id,
              邮箱: user.email,
              姓名: user.name || '-',
              机构: user.organization || '-',
              电话: user.phone || '-',
              管理员: user.is_admin ? '是' : '否',
              配额: user.usage_quota === null ? '无限制' : user.usage_quota,
              已用: user.usage_used || 0,
              状态: user.status === 'active' ? '活跃' : '禁用',
              注册时间: user.created_at ? new Date(user.created_at).toLocaleString() : '-'
            })),
            columns: [
              { key: '用户ID', label: 'ID', align: 'center' },
              { key: '邮箱', label: '邮箱', align: 'left' },
              { key: '姓名', label: '姓名', align: 'left' },
              { key: '机构', label: '机构', align: 'left' },
              { key: '管理员', label: '管理员', align: 'center' },
              { key: '配额', label: '配额', align: 'right' },
              { key: '已用', label: '已用', align: 'right' },
              { key: '状态', label: '状态', align: 'center' }
            ],
            width: '1000px'
          });
        }catch(e){ showError('用户搜索异常', e.toString()); }
      });

      // ==================== 上游服务配置功能 ====================
      
      // 上游服务配置：列出所有服务
      document.getElementById('btnListUpstreamServices')?.addEventListener('click', async () => {
        const tok = (adminTokenInput.value||'').trim(); 
        if(!tok){ showWarning('管理员令牌验证\n\n请先输入管理员令牌以验证身份'); return; }
        
        try{
          const res = await fetch('/api/admin/upstream-services', { 
            headers:{ 'X-Admin-Token': tok, 'X-User-Id': currentUser?.id || '1' } 
          });
          const data = await res.json();
          if(!res.ok){ 
            showError('获取上游服务列表失败', data?.detail || '服务器错误 ' + res.status); 
            return; 
          }
          
          // 显示上游服务列表表格（带操作按钮）
          showDataTable({
            title: '⚙️ 上游服务配置列表',
            message: `共配置 ${data.length} 个上游服务`,
            data: data.map(service => ({
              服务键名: service.key,
              服务名称: service.name,
              服务URL: service.url,
              模型: service.model || '-',
              描述: service.description || '-',
              状态: service.enabled ? '启用' : '禁用',
              当前使用: service.is_current ? '✅ 是' : '❌ 否',
              操作: service.key === 'default' ? '默认服务' : 
                `<div class="service-actions">
                  <button class="btn admin-btn" onclick="editUpstreamService('${service.key}', '${service.name}', '${service.url}', '${service.model || ''}', '${service.description || ''}', ${service.enabled})" style="padding: 4px 8px; font-size: 12px;">
                    ✏️ 编辑
                  </button>
                  <button class="btn admin-btn danger" onclick="deleteUpstreamService('${service.key}', '${service.name}')" style="padding: 4px 8px; font-size: 12px;">
                    🗑️ 删除
                  </button>
                </div>`
            })),
            columns: [
              { key: '服务键名', label: '键名', align: 'left' },
              { key: '服务名称', label: '名称', align: 'left' },
              { key: '服务URL', label: 'URL', align: 'left' },
              { key: '模型', label: '模型', align: 'left' },
              { key: '描述', label: '描述', align: 'left' },
              { key: '状态', label: '状态', align: 'center' },
              { key: '当前使用', label: '当前使用', align: 'center' },
              { key: '操作', label: '操作', align: 'center' }
            ],
            width: '1200px'
          });
        }catch(e){ 
          showError('请求异常', e.toString()); 
        }
      });

      // 上游服务配置：添加新服务
      document.getElementById('btnAddUpstreamService')?.addEventListener('click', async () => {
        const tok = (adminTokenInput.value||'').trim(); 
        if(!tok){ showWarning('管理员令牌验证\n\n请先输入管理员令牌以验证身份'); return; }
        
        // 显示添加服务对话框
        const serviceKey = prompt('请输入服务键名（如：backup1）:');
        if (!serviceKey) return;
        
        const serviceName = prompt('请输入服务名称:');
        if (!serviceName) return;
        
        const serviceUrl = prompt('请输入服务URL:');
        if (!serviceUrl) return;
        
        const serviceModel = prompt('请输入模型名称（默认: hf.co/unsloth/medgemma-4b-it-GGUF:Q4_K_M）:') || 'hf.co/unsloth/medgemma-4b-it-GGUF:Q4_K_M';
        
        const serviceDesc = prompt('请输入服务描述（可选）:') || '';
        
        try{
          const res = await fetch(`/api/admin/upstream-services?service_key=${encodeURIComponent(serviceKey)}`, { 
            method: 'POST',
            headers:{ 
              'X-Admin-Token': tok, 
              'X-User-Id': currentUser?.id || '1',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: serviceName,
              url: serviceUrl,
              model: serviceModel,
              description: serviceDesc,
              enabled: true
            })
          });
          const data = await res.json();
          if(!res.ok){ 
            showError('添加上游服务失败', data?.detail || '服务器错误 ' + res.status); 
            return; 
          }
          
          showSuccess('上游服务添加成功！', `服务 "${serviceName}" 已添加到配置中`);
        }catch(e){ 
          showError('添加服务异常', e.toString()); 
        }
      });

      // 上游服务配置：健康检查
      document.getElementById('btnCheckUpstreamHealth')?.addEventListener('click', async () => {
        const tok = (adminTokenInput.value||'').trim(); 
        if(!tok){ showWarning('管理员令牌验证\n\n请先输入管理员令牌以验证身份'); return; }
        
        try{
          const res = await fetch('/api/admin/upstream-services/health', { 
            headers:{ 'X-Admin-Token': tok, 'X-User-Id': currentUser?.id || '1' } 
          });
          const data = await res.json();
          if(!res.ok){ 
            showError('健康检查失败', data?.detail || '服务器错误 ' + res.status); 
            return; 
          }
          
          // 显示健康检查结果
          const healthData = Object.entries(data).map(([key, status]) => ({
            服务键名: key,
            健康状态: status.status,
            详细信息: status.message
          }));
          
          showDataTable({
            title: '🏥 上游服务健康检查',
            message: `检查了 ${healthData.length} 个服务的健康状态`,
            data: healthData,
            columns: [
              { key: '服务键名', label: '服务', align: 'left' },
              { key: '健康状态', label: '状态', align: 'center' },
              { key: '详细信息', label: '详情', align: 'left' }
            ],
            width: '800px'
          });
        }catch(e){ 
          showError('健康检查异常', e.toString()); 
        }
      });

      // 上游服务配置：切换服务
      document.getElementById('btnSwitchUpstreamService')?.addEventListener('click', async () => {
        const tok = (adminTokenInput.value||'').trim(); 
        if(!tok){ showWarning('管理员令牌验证\n\n请先输入管理员令牌以验证身份'); return; }
        
        // 先获取当前服务列表
        try{
          const res = await fetch('/api/admin/upstream-services', { 
            headers:{ 'X-Admin-Token': tok, 'X-User-Id': currentUser?.id || '1' } 
          });
          const services = await res.json();
          if(!res.ok){ 
            showError('获取服务列表失败', services?.detail || '服务器错误 ' + res.status); 
            return; 
          }
          
          const enabledServices = services.filter(s => s.enabled);
          if (enabledServices.length === 0) {
            showWarning('没有可用的上游服务');
            return;
          }
          
          // 显示服务选择对话框
          const serviceList = enabledServices.map(s => `${s.key}: ${s.name} (${s.url})`).join('\n');
          const selectedKey = prompt(`请选择要切换到的服务键名:\n\n${serviceList}\n\n请输入键名:`);
          if (!selectedKey) return;
          
          // 切换服务
          const switchRes = await fetch('/api/admin/upstream-services/switch', { 
            method: 'POST',
            headers:{ 
              'X-Admin-Token': tok, 
              'X-User-Id': currentUser?.id || '1',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              service_key: selectedKey
            })
          });
          const switchData = await switchRes.json();
          if(!switchRes.ok){ 
            showError('切换服务失败', switchData?.detail || '服务器错误 ' + switchRes.status); 
            return; 
          }
          
          showSuccess('上游服务切换成功！', switchData.message);
          
          // 更新当前服务显示
          updateCurrentServiceInfo();
        }catch(e){ 
          showError('切换服务异常', e.toString()); 
        }
      });

      // 更新当前服务信息显示
      async function updateCurrentServiceInfo() {
        const tok = (adminTokenInput.value||'').trim(); 
        if(!tok) return;
        
        try{
          const res = await fetch('/api/admin/upstream-services/current', { 
            headers:{ 'X-Admin-Token': tok, 'X-User-Id': currentUser?.id || '1' } 
          });
          const data = await res.json();
          if(res.ok && data) {
            const currentServiceInfo = document.getElementById('currentServiceInfo');
            if (currentServiceInfo) {
              currentServiceInfo.innerHTML = `
                <div class="service-item">
                  <span class="service-name">${data.name}</span>
                  <span class="service-status healthy">运行中</span>
                </div>
                <div style="font-size: 12px; color: var(--gray-500); margin-top: 4px;">
                  <div>URL: ${data.url}</div>
                  <div>模型: ${data.model || 'hf.co/unsloth/medgemma-4b-it-GGUF:Q4_K_M'}</div>
                </div>
              `;
            }
          }
        }catch(e){ 
          console.warn('更新当前服务信息失败:', e);
        }
      }

      // 页面加载时更新当前服务信息
      if (adminTokenInput) {
        adminTokenInput.addEventListener('input', () => {
          if (adminTokenInput.value.trim() === 'secret-admin') {
            updateCurrentServiceInfo();
          }
        });
      }

      // 编辑上游服务
      window.editUpstreamService = async function(serviceKey, currentName, currentUrl, currentModel, currentDesc, currentEnabled) {
        const tok = (adminTokenInput.value||'').trim(); 
        if(!tok){ showWarning('管理员令牌验证\n\n请先输入管理员令牌以验证身份'); return; }
        
        // 显示编辑对话框
        const newName = prompt('请输入服务名称:', currentName);
        if (newName === null) return; // 用户取消
        
        const newUrl = prompt('请输入服务URL:', currentUrl);
        if (newUrl === null) return; // 用户取消
        
        const newModel = prompt('请输入模型名称:', currentModel);
        if (newModel === null) return; // 用户取消
        
        const newDesc = prompt('请输入服务描述:', currentDesc);
        if (newDesc === null) return; // 用户取消
        
        const newEnabled = confirm('是否启用此服务？\n\n点击"确定"启用，点击"取消"禁用');
        
        try{
          const res = await fetch(`/api/admin/upstream-services/${encodeURIComponent(serviceKey)}`, { 
            method: 'PUT',
            headers:{ 
              'X-Admin-Token': tok, 
              'X-User-Id': currentUser?.id || '1',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              name: newName,
              url: newUrl,
              model: newModel,
              description: newDesc,
              enabled: newEnabled
            })
          });
          const data = await res.json();
          if(!res.ok){ 
            showError('更新上游服务失败', data?.detail || '服务器错误 ' + res.status); 
            return; 
          }
          
          showSuccess('上游服务更新成功！', `服务 "${newName}" 已更新`);
          
          // 如果更新的是当前服务，刷新当前服务显示
          if (data.is_current) {
            updateCurrentServiceInfo();
          }
        }catch(e){ 
          showError('更新服务异常', e.toString()); 
        }
      };

      // 删除上游服务
      window.deleteUpstreamService = async function(serviceKey, serviceName) {
        const tok = (adminTokenInput.value||'').trim(); 
        if(!tok){ showWarning('管理员令牌验证\n\n请先输入管理员令牌以验证身份'); return; }
        
        // 确认删除
        const confirmed = confirm(`确认删除上游服务？\n\n服务名称: ${serviceName}\n服务键名: ${serviceKey}\n\n此操作不可恢复！`);
        if (!confirmed) return;
        
        try{
          const res = await fetch(`/api/admin/upstream-services/${encodeURIComponent(serviceKey)}`, { 
            method: 'DELETE',
            headers:{ 
              'X-Admin-Token': tok, 
              'X-User-Id': currentUser?.id || '1'
            }
          });
          const data = await res.json();
          if(!res.ok){ 
            showError('删除上游服务失败', data?.detail || '服务器错误 ' + res.status); 
            return; 
          }
          
          showSuccess('上游服务删除成功！', `服务 "${serviceName}" 已删除`);
          
          // 更新当前服务显示
          updateCurrentServiceInfo();
        }catch(e){ 
          showError('删除服务异常', e.toString()); 
        }
      };

      // 移动端侧栏抽屉
      btnMenu.addEventListener('click', ()=>{
        document.querySelector('.side').classList.add('open');
        drawerBackdrop.style.display='block';
      });
      drawerBackdrop.addEventListener('click', ()=>{
        document.querySelector('.side').classList.remove('open');
        drawerBackdrop.style.display='none';
      });
      window.addEventListener('keydown', (e)=>{
        if(e.key==='Escape'){
          document.querySelector('.side').classList.remove('open');
          drawerBackdrop.style.display='none';
        }
      });

      // 语音输入（Web Speech API）
      (function(){
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR){ const b=document.getElementById('mic'); b.style.opacity=.5; b.style.pointerEvents='none'; return; }
        const rec = new SR(); rec.lang='zh-CN'; rec.interimResults=true; rec.continuous=false;
        document.getElementById('mic').addEventListener('click', ()=>{ try{ rec.start(); document.getElementById('mic').classList.add('pulse'); }catch{} });
        rec.onresult = (e)=>{ let text=''; for(const r of e.results){ text += r[0].transcript; } promptEl.value = text; promptEl.dispatchEvent(new Event('input')); };
        rec.onend = ()=>{ document.getElementById('mic').classList.remove('pulse'); };
        rec.onerror = ()=>{ document.getElementById('mic').classList.remove('pulse'); };
      })();

      // 语音播报（Web Speech API TTS）
      function attachTts(container, text){
        if(!('speechSynthesis' in window)) return;
        const bar = document.createElement('div');
        bar.className = 'tts';
        const btnPlay = document.createElement('button'); btnPlay.textContent='播放'; btnPlay.title='播放语音';
        const btnPause = document.createElement('button'); btnPause.textContent='暂停'; btnPause.title='暂停/继续';
        const btnStop = document.createElement('button'); btnStop.textContent='停止'; btnStop.title='停止播放';
        const btnCopy = document.createElement('button'); btnCopy.textContent='复制'; btnCopy.title='复制消息内容';
        btnPause.disabled = true; btnStop.disabled = true;
        let utterance = null;
        function reset(){
          utterance = null;
          btnPlay.disabled = false;
          btnPause.disabled = true; btnPause.textContent='暂停';
          btnStop.disabled = true;
        }
        btnPlay.addEventListener('click', ()=>{
          const synth = window.speechSynthesis;
          try{ synth.cancel(); }catch{}
          utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = 'zh-CN';
          utterance.onend = reset;
          utterance.onerror = reset;
          synth.speak(utterance);
          btnPlay.disabled = true; btnPause.disabled = false; btnStop.disabled = false;
        });
        btnPause.addEventListener('click', ()=>{
          const synth = window.speechSynthesis;
          if(!utterance) return;
          if(synth.paused){ synth.resume(); btnPause.textContent='暂停'; }
          else { synth.pause(); btnPause.textContent='继续'; }
        });
        btnStop.addEventListener('click', ()=>{
          const synth = window.speechSynthesis;
          if(!utterance) return;
          synth.cancel();
          reset();
        });
        
        // 复制按钮功能
        btnCopy.addEventListener('click', async ()=>{
          try {
            await navigator.clipboard.writeText(text);
            // 显示复制成功反馈
            const originalText = btnCopy.textContent;
            btnCopy.textContent = '已复制';
            btnCopy.style.background = 'var(--success-50)';
            btnCopy.style.borderColor = 'var(--success-500)';
            btnCopy.style.color = 'var(--success-600)';
            setTimeout(() => {
              btnCopy.textContent = originalText;
              btnCopy.style.background = '';
              btnCopy.style.borderColor = '';
              btnCopy.style.color = '';
            }, 2000);
          } catch (err) {
            // 降级到旧的复制方法
            try {
              const textArea = document.createElement('textarea');
              textArea.value = text;
              textArea.style.position = 'fixed';
              textArea.style.left = '-999999px';
              textArea.style.top = '-999999px';
              document.body.appendChild(textArea);
              textArea.focus();
              textArea.select();
              document.execCommand('copy');
              document.body.removeChild(textArea);
              
              // 显示复制成功反馈
              const originalText = btnCopy.textContent;
              btnCopy.textContent = '已复制';
              btnCopy.style.background = 'var(--success-50)';
              btnCopy.style.borderColor = 'var(--success-500)';
              btnCopy.style.color = 'var(--success-600)';
              setTimeout(() => {
                btnCopy.textContent = originalText;
                btnCopy.style.background = '';
                btnCopy.style.borderColor = '';
                btnCopy.style.color = '';
              }, 2000);
            } catch (fallbackErr) {
              console.error('复制失败:', fallbackErr);
              btnCopy.textContent = '复制失败';
              setTimeout(() => {
                btnCopy.textContent = '复制';
              }, 2000);
            }
          }
        });
        
        bar.appendChild(btnPlay); bar.appendChild(btnPause); bar.appendChild(btnStop); bar.appendChild(btnCopy);
        container.appendChild(bar);
      }
      // 显示用户列表弹窗
      function showUserListModal(users) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        const modalCard = document.createElement('div');
        modalCard.className = 'modal-card';
        modalCard.style.width = '900px';
        modalCard.style.maxWidth = '95vw';
        modalCard.style.maxHeight = '80vh';
        modalCard.style.overflow = 'hidden';
        modalCard.style.display = 'flex';
        modalCard.style.flexDirection = 'column';
        
        // 标题栏
        const header = document.createElement('div');
        header.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px 24px;
          border-bottom: 1px solid var(--border);
          background: var(--primary-50);
          border-radius: 20px 20px 0 0;
        `;
        
        const title = document.createElement('h3');
        title.textContent = `👥 用户列表 (${users.length} 位用户)`;
        title.style.margin = '0';
        title.style.color = 'var(--primary-700)';
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '×';
        closeBtn.style.cssText = `
          background: var(--error-50);
          color: var(--error-500);
          border: none;
          width: 32px;
          height: 32px;
          border-radius: 50%;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: all 0.2s ease;
        `;
        closeBtn.addEventListener('click', () => {
          document.body.removeChild(modal);
          document.body.style.overflow = 'auto';
        });
        closeBtn.addEventListener('mouseenter', () => {
          closeBtn.style.background = 'var(--error-500)';
          closeBtn.style.color = 'white';
          closeBtn.style.transform = 'scale(1.1)';
        });
        closeBtn.addEventListener('mouseleave', () => {
          closeBtn.style.background = 'var(--error-50)';
          closeBtn.style.color = 'var(--error-500)';
          closeBtn.style.transform = 'scale(1)';
        });
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        
        // 内容区域
        const content = document.createElement('div');
        content.style.cssText = `
          flex: 1;
          overflow-y: auto;
          padding: 0;
        `;
        
        // 用户列表表格
        const table = document.createElement('table');
        table.style.cssText = `
          width: 100%;
          border-collapse: collapse;
          font-size: 14px;
        `;
        
        // 表头
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr style="background: var(--gray-50); position: sticky; top: 0; z-index: 10;">
            <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">ID</th>
            <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">邮箱</th>
            <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">姓名</th>
            <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">机构</th>
            <th style="padding: 12px 16px; text-align: center; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">管理员</th>
            <th style="padding: 12px 16px; text-align: right; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">配额</th>
            <th style="padding: 12px 16px; text-align: right; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">已用</th>
            <th style="padding: 12px 16px; text-align: center; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">状态</th>
          </tr>
        `;
        
        // 表体
        const tbody = document.createElement('tbody');
        users.forEach((user, index) => {
          const row = document.createElement('tr');
          row.style.cssText = `
            border-bottom: 1px solid var(--border);
            transition: background-color 0.2s ease;
            cursor: pointer;
          `;
          row.addEventListener('mouseenter', () => {
            row.style.backgroundColor = 'var(--primary-50)';
          });
          row.addEventListener('mouseleave', () => {
            row.style.backgroundColor = index % 2 === 0 ? 'white' : 'var(--gray-25)';
          });
          
          if (index % 2 === 1) {
            row.style.backgroundColor = 'var(--gray-25)';
          }
          
          const adminBadge = user.is_admin ? 
            '<span style="background: var(--error-100); color: var(--error-700); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">管理员</span>' : 
            '<span style="background: var(--gray-100); color: var(--gray-600); padding: 2px 8px; border-radius: 12px; font-size: 12px;">普通用户</span>';
          
          const statusBadge = (user.status === 'active' || !user.status) ?
            '<span style="background: var(--success-100); color: var(--success-700); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">活跃</span>' :
            '<span style="background: var(--warning-100); color: var(--warning-700); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">禁用</span>';
          
          row.innerHTML = `
            <td style="padding: 12px 16px; font-weight: 600; color: var(--primary-600);">${user.id}</td>
            <td style="padding: 12px 16px; font-family: 'Courier New', monospace; color: var(--gray-700); max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${user.email || '-'}</td>
            <td style="padding: 12px 16px; color: var(--gray-700);">${user.name || '-'}</td>
            <td style="padding: 12px 16px; color: var(--gray-600); font-size: 13px; max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${user.organization || '-'}</td>
            <td style="padding: 12px 16px; text-align: center;">${adminBadge}</td>
            <td style="padding: 12px 16px; text-align: right; font-weight: 600; color: var(--gray-700);">${user.usage_quota === null ? '无限制' : user.usage_quota}</td>
            <td style="padding: 12px 16px; text-align: right; font-weight: 600; color: var(--primary-600);">${user.usage_used || 0}</td>
            <td style="padding: 12px 16px; text-align: center;">${statusBadge}</td>
          `;
          
          // 点击行显示详细信息
          row.addEventListener('click', () => {
            showUserDetailModal(user);
          });
          
          tbody.appendChild(row);
        });
        
        table.appendChild(thead);
        table.appendChild(tbody);
        content.appendChild(table);
        
        // 底部统计信息
        const footer = document.createElement('div');
        footer.style.cssText = `
          padding: 16px 24px;
          background: var(--gray-50);
          border-top: 1px solid var(--border);
          border-radius: 0 0 20px 20px;
          font-size: 13px;
          color: var(--gray-600);
        `;
        
        const adminCount = users.filter(u => u.is_admin).length;
        const activeCount = users.filter(u => u.status === 'active' || !u.status).length;
        
        footer.innerHTML = `
          📊 统计信息: 总用户 ${users.length} 位 | 管理员 ${adminCount} 位 | 活跃用户 ${activeCount} 位 | 
          <span style="color: var(--primary-600); font-weight: 600;">点击用户行查看详细信息</span>
        `;
        
        modalCard.appendChild(header);
        modalCard.appendChild(content);
        modalCard.appendChild(footer);
        modal.appendChild(modalCard);
        
        // 点击背景关闭
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
          }
        });
        
        // ESC键关闭
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
        
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
      }

      // 通用专业消息弹窗系统
      function showMessage(options) {
        const {
          title = '提示',
          message = '',
          type = 'info', // 'success', 'error', 'warning', 'info', 'confirm'
          data = null,
          showData = false,
          onConfirm = null,
          onCancel = null,
          confirmText = '确定',
          cancelText = '取消',
          width = '500px'
        } = options;

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        const modalCard = document.createElement('div');
        modalCard.className = 'modal-card';
        modalCard.style.width = width;
        modalCard.style.maxWidth = '95vw';
        modalCard.style.maxHeight = '80vh';
        modalCard.style.overflow = 'auto';
        
        // 根据类型设置图标和颜色
        const typeConfig = {
          success: { icon: '✅', color: 'var(--success-600)', bg: 'var(--success-50)' },
          error: { icon: '❌', color: 'var(--error-600)', bg: 'var(--error-50)' },
          warning: { icon: '⚠️', color: 'var(--warning-600)', bg: 'var(--warning-50)' },
          info: { icon: 'ℹ️', color: 'var(--primary-600)', bg: 'var(--primary-50)' },
          confirm: { icon: '❓', color: 'var(--primary-600)', bg: 'var(--primary-50)' }
        };
        
        const config = typeConfig[type] || typeConfig.info;
        
        let content = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px 20px; background: ${config.bg}; border-radius: 12px; border-left: 4px solid ${config.color};">
            <h3 style="margin: 0; color: ${config.color}; display: flex; align-items: center; gap: 8px;">
              <span style="font-size: 20px;">${config.icon}</span>
              ${title}
            </h3>
            <button onclick="document.body.removeChild(this.closest('.modal')); document.body.style.overflow = 'auto';" style="background: var(--error-50); color: var(--error-500); border: none; width: 28px; height: 28px; border-radius: 50%; font-size: 16px; font-weight: bold; cursor: pointer;">×</button>
          </div>
          
          <div style="padding: 0 20px; margin-bottom: 20px;">
            <div style="font-size: 15px; line-height: 1.6; color: var(--gray-700); white-space: pre-wrap;">${message}</div>
        `;
        
        // 如果有数据需要显示
        if (showData && data) {
          content += `
            <div style="margin-top: 16px; padding: 16px; background: var(--gray-50); border-radius: 8px; border: 1px solid var(--border);">
              <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 8px; font-size: 14px;">详细信息:</div>
              <pre style="font-size: 13px; color: var(--gray-600); white-space: pre-wrap; font-family: 'Courier New', monospace; margin: 0; overflow-x: auto;">${typeof data === 'object' ? JSON.stringify(data, null, 2) : data}</pre>
            </div>
          `;
        }
        
        content += `</div>`;
        
        // 按钮区域
        content += `
          <div style="display: flex; gap: 12px; justify-content: flex-end; padding: 16px 20px; border-top: 1px solid var(--border); background: var(--gray-25);">
        `;
        
        if (type === 'confirm') {
          content += `
            <button onclick="handleCancel()" class="btn ghost">${cancelText}</button>
            <button onclick="handleConfirm()" class="btn primary">${confirmText}</button>
          `;
        } else {
          content += `
            <button onclick="document.body.removeChild(this.closest('.modal')); document.body.style.overflow = 'auto';" class="btn primary">${confirmText}</button>
          `;
        }
        
        content += `</div>`;
        
        modalCard.innerHTML = content;
        modal.appendChild(modalCard);
        
        // 处理确认和取消
        if (type === 'confirm') {
          window.handleConfirm = () => {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
            if (onConfirm) onConfirm();
          };
          
          window.handleCancel = () => {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
            if (onCancel) onCancel();
          };
        }
        
        // 点击背景关闭（除了confirm类型）
        if (type !== 'confirm') {
          modal.addEventListener('click', (e) => {
            if (e.target === modal) {
              document.body.removeChild(modal);
              document.body.style.overflow = 'auto';
            }
          });
        }
        
        // ESC键关闭
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
            document.removeEventListener('keydown', handleEscape);
            if (type === 'confirm' && onCancel) onCancel();
          }
        };
        document.addEventListener('keydown', handleEscape);
        
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        return modal;
      }

      // 便捷方法
      function showSuccess(message, data = null) {
        return showMessage({ type: 'success', title: '操作成功', message, data, showData: !!data });
      }
      
      function showError(message, data = null) {
        return showMessage({ type: 'error', title: '操作失败', message, data, showData: !!data });
      }
      
      function showWarning(message, data = null) {
        return showMessage({ type: 'warning', title: '警告提示', message, data, showData: !!data });
      }
      
      function showInfo(message, data = null) {
        return showMessage({ type: 'info', title: '信息提示', message, data, showData: !!data });
      }
      
      function showConfirm(message, onConfirm, onCancel = null) {
        return showMessage({ 
          type: 'confirm', 
          title: '确认操作', 
          message, 
          onConfirm, 
          onCancel 
        });
      }

      // 显示数据表格弹窗
      function showDataTable(options) {
        const {
          title = '数据列表',
          data = [],
          columns = [],
          message = '',
          width = '800px'
        } = options;

        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        const modalCard = document.createElement('div');
        modalCard.className = 'modal-card';
        modalCard.style.width = width;
        modalCard.style.maxWidth = '95vw';
        modalCard.style.maxHeight = '80vh';
        modalCard.style.overflow = 'hidden';
        modalCard.style.display = 'flex';
        modalCard.style.flexDirection = 'column';
        
        // 标题栏
        const header = document.createElement('div');
        header.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px 24px;
          border-bottom: 1px solid var(--border);
          background: var(--primary-50);
          border-radius: 20px 20px 0 0;
        `;
        
        const titleEl = document.createElement('h3');
        titleEl.textContent = title;
        titleEl.style.margin = '0';
        titleEl.style.color = 'var(--primary-700)';
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '×';
        closeBtn.style.cssText = `
          background: var(--error-50);
          color: var(--error-500);
          border: none;
          width: 32px;
          height: 32px;
          border-radius: 50%;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.2s ease;
        `;
        closeBtn.addEventListener('click', () => {
          document.body.removeChild(modal);
          document.body.style.overflow = 'auto';
        });
        
        header.appendChild(titleEl);
        header.appendChild(closeBtn);
        
        // 内容区域
        const content = document.createElement('div');
        content.style.cssText = `
          flex: 1;
          overflow-y: auto;
          padding: 16px 0;
        `;
        
        if (message) {
          const messageDiv = document.createElement('div');
          messageDiv.style.cssText = `
            padding: 0 24px 16px 24px;
            color: var(--gray-600);
            font-size: 14px;
          `;
          messageDiv.textContent = message;
          content.appendChild(messageDiv);
        }
        
        // 创建表格
        if (Array.isArray(data) && data.length > 0) {
          const table = document.createElement('table');
          table.style.cssText = `
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
          `;
          
          // 如果没有提供列配置，自动生成
          const actualColumns = columns.length > 0 ? columns : 
            Object.keys(data[0]).map(key => ({ key, label: key, align: 'left' }));
          
          // 表头
          const thead = document.createElement('thead');
          const headerRow = document.createElement('tr');
          headerRow.style.cssText = `
            background: var(--gray-50);
            position: sticky;
            top: 0;
            z-index: 10;
          `;
          
          actualColumns.forEach(col => {
            const th = document.createElement('th');
            th.style.cssText = `
              padding: 12px 16px;
              text-align: ${col.align || 'left'};
              border-bottom: 2px solid var(--border);
              font-weight: 600;
              color: var(--gray-700);
            `;
            th.textContent = col.label || col.key;
            headerRow.appendChild(th);
          });
          
          thead.appendChild(headerRow);
          table.appendChild(thead);
          
          // 表体
          const tbody = document.createElement('tbody');
          data.forEach((item, index) => {
            const row = document.createElement('tr');
            row.style.cssText = `
              border-bottom: 1px solid var(--border);
              transition: background-color 0.2s ease;
            `;
            
            if (index % 2 === 1) {
              row.style.backgroundColor = 'var(--gray-25)';
            }
            
            row.addEventListener('mouseenter', () => {
              row.style.backgroundColor = 'var(--primary-50)';
            });
            row.addEventListener('mouseleave', () => {
              row.style.backgroundColor = index % 2 === 0 ? 'white' : 'var(--gray-25)';
            });
            
            actualColumns.forEach(col => {
              const td = document.createElement('td');
              td.style.cssText = `
                padding: 12px 16px;
                text-align: ${col.align || 'left'};
                color: var(--gray-700);
              `;
              
              let value = item[col.key];
              if (col.render) {
                value = col.render(value, item);
              } else if (typeof value === 'object') {
                value = JSON.stringify(value);
              }
              
              td.innerHTML = value || '-';
              row.appendChild(td);
            });
            
            tbody.appendChild(row);
          });
          
          table.appendChild(tbody);
          content.appendChild(table);
        } else {
          const emptyDiv = document.createElement('div');
          emptyDiv.style.cssText = `
            padding: 40px 24px;
            text-align: center;
            color: var(--gray-500);
            font-size: 14px;
          `;
          emptyDiv.innerHTML = '📭 暂无数据';
          content.appendChild(emptyDiv);
        }
        
        modalCard.appendChild(header);
        modalCard.appendChild(content);
        modal.appendChild(modalCard);
        
        // 点击背景关闭
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
          }
        });
        
        // ESC键关闭
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
        
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        return modal;
      }

      // 显示编辑用户弹窗
      function showEditUserModal(user) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        const modalCard = document.createElement('div');
        modalCard.className = 'modal-card';
        modalCard.style.width = '600px';
        modalCard.style.maxWidth = '95vw';
        
        modalCard.innerHTML = `
          <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); border-radius: 20px 20px 0 0; background: var(--primary-50);">
            <div>
              <h3 style="margin: 0; color: var(--primary-700);">✏️ 编辑用户信息</h3>
              <p style="margin: 4px 0 0 0; font-size: 14px; color: var(--primary-600);">修改用户 ${user.name || user.email} 的基本信息</p>
            </div>
            <button onclick="closeModal(this.closest('.modal'))" style="background: var(--error-50); color: var(--error-500); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold;">×</button>
          </div>
          
          <div style="padding: 24px;">
            <div style="margin-bottom: 20px; padding: 16px; background: var(--primary-50); border-radius: 12px;">
              <div style="font-weight: 600; color: var(--primary-700); margin-bottom: 8px;">当前用户信息</div>
              <div style="font-size: 14px; color: var(--primary-600);">
                <div>ID: ${user.id} | 邮箱: ${user.email}</div>
                <div>姓名: ${user.name || '-'} | 机构: ${user.organization || '-'}</div>
              </div>
            </div>
            
            <div style="display: grid; gap: 16px; margin-bottom: 24px;">
              <div class="form-field">
                <label>用户姓名 *</label>
                <input id="editUserName" type="text" placeholder="请输入用户姓名" value="${user.name || ''}" style="width: 100%;" />
                <div class="field-hint">用户的真实姓名</div>
              </div>
              
              <div class="form-field">
                <label>邮箱地址 *</label>
                <input id="editUserEmail" type="email" placeholder="请输入邮箱地址" value="${user.email || ''}" data-original-email="${user.email || ''}" style="width: 100%;" />
                <div class="field-hint">用户的登录邮箱</div>
              </div>
              
              <div class="form-field">
                <label>手机号码</label>
                <input id="editUserPhone" type="tel" placeholder="请输入手机号码" value="${user.phone || ''}" style="width: 100%;" />
                <div class="field-hint">用户的联系电话</div>
              </div>
              
              <div class="form-field">
                <label>所属机构</label>
                <input id="editUserOrg" type="text" placeholder="请输入所属机构" value="${user.organization || ''}" style="width: 100%;" />
                <div class="field-hint">用户所属的医院或机构</div>
              </div>
              
              <div class="form-field">
                <label>用户状态</label>
                <select id="editUserStatus" style="width: 100%;">
                  <option value="active" ${(user.status === 'active' || !user.status) ? 'selected' : ''}>活跃</option>
                  <option value="disabled" ${user.status === 'disabled' ? 'selected' : ''}>禁用</option>
                </select>
                <div class="field-hint">设置用户的账户状态</div>
              </div>
              
              <div class="form-field">
                <label>管理员权限</label>
                <select id="editUserAdmin" style="width: 100%;">
                  <option value="false" ${!user.is_admin ? 'selected' : ''}>普通用户</option>
                  <option value="true" ${user.is_admin ? 'selected' : ''}>管理员</option>
                </select>
                <div class="field-hint">设置用户的管理员权限</div>
              </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="closeModal(this.closest('.modal'))" class="btn-secondary">取消</button>
              <button onclick="saveUserEdit(${user.id})" class="btn-primary">保存修改</button>
            </div>
          </div>
        `;
        
        modal.appendChild(modalCard);
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        // 聚焦到第一个输入框
        setTimeout(() => {
          document.getElementById('editUserName').focus();
        }, 100);
      }

      // 邮箱验证函数
      function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // 保存用户编辑 - 全局函数
      window.saveUserEdit = async function(userId) {
        const name = document.getElementById('editUserName').value.trim();
        const email = document.getElementById('editUserEmail').value.trim();
        const phone = document.getElementById('editUserPhone').value.trim();
        const organization = document.getElementById('editUserOrg').value.trim();
        const status = document.getElementById('editUserStatus').value;
        const isAdmin = document.getElementById('editUserAdmin').value === 'true';
        
        // 获取原始用户邮箱（从隐藏字段或全局变量）
        const originalEmail = document.getElementById('editUserEmail').getAttribute('data-original-email') || email;
        
        // 验证必填字段
        if (!name) {
          showWarning('请输入用户姓名');
          return;
        }
        if (!email) {
          showWarning('请输入邮箱地址');
          return;
        }
        if (!isValidEmail(email)) {
          showWarning('请输入有效的邮箱地址');
          return;
        }
        
        const tok = (adminTokenInput?.value || '').trim();
        if (!tok) {
          showWarning('请先填写管理员令牌');
          return;
        }
        
        try {
          const updateData = {
            name: name,
            phone: phone || null,
            organization: organization || null,
            status: status,
            is_admin: isAdmin
          };
          
          // 只有当邮箱发生变化时才更新邮箱
          if (email !== originalEmail) {
            updateData.email = email;
          }
          
          // 构建API URL
          const apiUrl = `${window.location.protocol}//${window.location.host}/api/admin/users/${userId}`;
          
          console.log('发送用户更新请求:', {
            url: apiUrl,
            data: updateData,
            token: tok
          });
          
          const response = await fetch(apiUrl, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              'X-Admin-Token': tok
            },
            body: JSON.stringify(updateData)
          });
          
          let data;
          let responseText;
          
          console.log('收到响应:', {
            status: response.status,
            statusText: response.statusText,
            headers: Object.fromEntries(response.headers.entries())
          });
          
          // 先获取响应文本
          try {
            responseText = await response.text();
            console.log('响应文本:', responseText);
            // 尝试解析为JSON
            data = JSON.parse(responseText);
            console.log('解析后的数据:', data);
          } catch (jsonError) {
            console.error('JSON解析错误:', jsonError);
            // 如果解析JSON失败，使用原始文本
            showError('更新失败', `服务器错误 ${response.status}: ${responseText}`);
            return;
          }
          
          if (!response.ok) {
            showError('更新失败', data?.detail || `服务器错误 ${response.status}`);
            return;
          }
          
          showSuccess('用户信息更新成功！', `用户 ${name} 的信息已更新`);
          
          // 关闭弹窗
          const modal = document.querySelector('.modal:last-of-type');
          if (modal) {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
          }
          
          // 刷新用户列表 - 通过增强用户管理界面的刷新按钮
          const refreshBtn = document.querySelector('button[innerHTML*="🔄 刷新"]');
          if (refreshBtn) {
            refreshBtn.click();
          } else {
            // 如果找不到刷新按钮，重新加载用户列表
            setTimeout(() => {
              const listBtn = document.getElementById('btnListUsers');
              if (listBtn) {
                listBtn.click();
              }
            }, 1000);
          }
          
        } catch (e) {
          showError('更新异常', e.toString());
        }
      };

      // 确认删除用户
      function confirmDeleteUser(userId, userName) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        const modalCard = document.createElement('div');
        modalCard.className = 'modal-card';
        modalCard.style.width = '500px';
        modalCard.style.maxWidth = '95vw';
        
        modalCard.innerHTML = `
          <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); border-radius: 20px 20px 0 0; background: var(--error-50);">
            <div>
              <h3 style="margin: 0; color: var(--error-700);">⚠️ 确认删除用户</h3>
              <p style="margin: 4px 0 0 0; font-size: 14px; color: var(--error-600);">此操作不可撤销，请谨慎操作</p>
            </div>
            <button onclick="closeModal(this.closest('.modal'))" style="background: var(--error-100); color: var(--error-500); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold;">×</button>
          </div>
          
          <div style="padding: 24px;">
            <div style="margin-bottom: 20px; padding: 16px; background: var(--warning-50); border-radius: 12px; border-left: 4px solid var(--warning-500);">
              <div style="font-weight: 600; color: var(--warning-700); margin-bottom: 8px;">⚠️ 删除警告</div>
              <div style="font-size: 14px; color: var(--warning-600);">
                您即将删除用户 <strong>"${userName}"</strong>，此操作将：
                <ul style="margin: 8px 0; padding-left: 20px;">
                  <li>永久删除用户账户</li>
                  <li>清除所有用户数据</li>
                  <li>删除使用记录</li>
                  <li>此操作无法撤销</li>
                </ul>
              </div>
            </div>
            
            <div style="margin-bottom: 24px; padding: 16px; background: var(--gray-50); border-radius: 12px;">
              <div style="font-weight: 600; color: var(--gray-700); margin-bottom: 8px;">请确认删除</div>
              <div style="font-size: 14px; color: var(--gray-600);">
                如果您确定要删除此用户，请在下方输入框中输入 <strong>"删除"</strong> 来确认操作。
              </div>
              <input id="deleteConfirmInput" type="text" placeholder="请输入"删除"来确认" style="width: 100%; margin-top: 12px;" />
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="closeModal(this.closest('.modal'))" class="btn-secondary">取消</button>
              <button onclick="deleteUser(${userId}, '${userName.replace(/'/g, "\\'")}')" class="btn-error" id="deleteConfirmBtn" disabled>确认删除</button>
            </div>
          </div>
        `;
        
        modal.appendChild(modalCard);
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        // 监听确认输入
        const confirmInput = document.getElementById('deleteConfirmInput');
        const confirmBtn = document.getElementById('deleteConfirmBtn');
        
        confirmInput.addEventListener('input', (e) => {
          if (e.target.value.trim() === '删除') {
            confirmBtn.disabled = false;
            confirmBtn.style.background = 'var(--error-500)';
            confirmBtn.style.color = 'white';
          } else {
            confirmBtn.disabled = true;
            confirmBtn.style.background = 'var(--gray-300)';
            confirmBtn.style.color = 'var(--gray-500)';
          }
        });
        
        // 聚焦到输入框
        setTimeout(() => {
          confirmInput.focus();
        }, 100);
      }

      // 删除用户
      async function deleteUser(userId, userName) {
        const tok = (adminTokenInput?.value || '').trim();
        if (!tok) {
          showWarning('请先填写管理员令牌');
          return;
        }
        
        try {
          const response = await fetch(`/api/admin/users/${userId}`, {
            method: 'DELETE',
            headers: {
              'X-Admin-Token': tok
            }
          });
          
          const data = await response.json();
          
          if (!response.ok) {
            showError('删除失败', data?.detail || '服务器错误 ' + response.status);
            return;
          }
          
          showSuccess(`用户 "${userName}" 已成功删除！`);
          
          // 关闭弹窗
          const modal = document.querySelector('.modal:last-of-type');
          if (modal) {
            closeModal(modal);
          }
          
          // 刷新用户列表
          const refreshBtn = document.querySelector('[onclick*="refreshBtn"]');
          if (refreshBtn) {
            refreshBtn.click();
          }
          
        } catch (e) {
          showError('删除异常', e.toString());
        }
      }

      // 显示增强的用户管理界面
      function showEnhancedUserManagement(users) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        const modalCard = document.createElement('div');
        modalCard.className = 'modal-card';
        modalCard.style.width = '1200px';
        modalCard.style.maxWidth = '95vw';
        modalCard.style.maxHeight = '90vh';
        modalCard.style.overflow = 'hidden';
        modalCard.style.display = 'flex';
        modalCard.style.flexDirection = 'column';
        
        // 标题栏
        const header = document.createElement('div');
        header.style.cssText = `
          display: flex;
          justify-content: space-between;
          align-items: center;
          padding: 20px 24px;
          border-bottom: 1px solid var(--border);
          background: linear-gradient(135deg, var(--primary-50), var(--primary-100));
          border-radius: 20px 20px 0 0;
        `;
        const title = document.createElement('h3');
        title.textContent = `👥 用户管理中心 (${users.length} 位用户)`;
        title.style.margin = '0';
        title.style.color = 'var(--primary-700)';
        title.style.fontSize = '18px';
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '×';
        closeBtn.style.cssText = `
          background: var(--error-50);
          color: var(--error-500);
          border: none;
          width: 36px;
          height: 36px;
          border-radius: 50%;
          font-size: 20px;
          font-weight: bold;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
        `;
        closeBtn.addEventListener('click', () => {
          document.body.removeChild(modal);
          document.body.style.overflow = 'auto';
        });
        header.appendChild(title);
        header.appendChild(closeBtn);
        // 工具栏
  //（已合并到上方，移除重复声明）

        // 新增用户按钮
  const addUserBtn = document.createElement('button');
  addUserBtn.innerHTML = '➕ 新增用户';
  addUserBtn.className = 'btn primary';
  addUserBtn.style.whiteSpace = 'nowrap';
  addUserBtn.style.fontWeight = '500';
  addUserBtn.style.fontSize = '15px';
  addUserBtn.style.padding = '8px 18px';
  addUserBtn.style.borderRadius = '8px';
  addUserBtn.style.border = 'none';
  addUserBtn.style.background = 'var(--primary-500)';
  addUserBtn.style.color = 'white';
  addUserBtn.style.transition = 'background 0.2s';
  addUserBtn.onmouseenter = () => { addUserBtn.style.background = 'var(--primary-600)'; };
  addUserBtn.onmouseleave = () => { addUserBtn.style.background = 'var(--primary-500)'; };
  addUserBtn.onclick = () => window.showAddUserModal();

          // 新增用户弹窗
          window.showAddUserModal = function() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            const modalCard = document.createElement('div');
            modalCard.className = 'modal-card';
            modalCard.style.width = '500px';
            modalCard.style.maxWidth = '95vw';
            modalCard.innerHTML = `
              <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid var(--border); border-radius: 20px 20px 0 0; background: var(--primary-50);">
                <div>
                  <h3 style="margin: 0; color: var(--primary-700);">➕ 新增用户</h3>
                  <p style="margin: 4px 0 0 0; font-size: 14px; color: var(--primary-600);">请填写新用户信息</p>
                </div>
                <button onclick="closeModal(this.closest('.modal'))" style="background: var(--error-50); color: var(--error-500); border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; font-weight: bold;">×</button>
              </div>
              <div style="padding: 24px;">
                <div class="form-field">
                  <label>姓名 *</label>
                  <input id="addUserName" type="text" placeholder="请输入姓名" style="width: 100%;" />
                </div>
                <div class="form-field">
                  <label>邮箱 *</label>
                  <input id="addUserEmail" type="email" placeholder="请输入邮箱" style="width: 100%;" />
                </div>
                <div class="form-field">
                  <label>手机号</label>
                  <input id="addUserPhone" type="tel" placeholder="请输入手机号" style="width: 100%;" />
                </div>
                <div class="form-field">
                  <label>机构 *</label>
                  <input id="addUserOrg" type="text" placeholder="请输入机构" style="width: 100%;" />
                </div>
                <div class="form-field">
                  <label>初始密码 *</label>
                  <input id="addUserPwd" type="password" placeholder="请输入初始密码" style="width: 100%;" />
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;">
                  <button onclick="closeModal(this.closest('.modal'))" class="btn-secondary">取消</button>
                  <button onclick="saveAddUser()" class="btn-primary">创建</button>
                </div>
              </div>
            `;
            modal.appendChild(modalCard);
            document.body.appendChild(modal);
            document.body.style.overflow = 'hidden';
            setTimeout(() => {
              document.getElementById('addUserName').focus();
            }, 100);
          };

          // 新增用户保存逻辑
          window.saveAddUser = async function() {
            const name = document.getElementById('addUserName').value.trim();
            const email = document.getElementById('addUserEmail').value.trim();
            const phone = document.getElementById('addUserPhone').value.trim();
            const organization = document.getElementById('addUserOrg').value.trim();
            const password = document.getElementById('addUserPwd').value.trim();
            if (!name) return showWarning('请输入姓名');
            if (!email) return showWarning('请输入邮箱');
            if (!isValidEmail(email)) return showWarning('请输入有效邮箱');
            if (!organization) return showWarning('请输入机构');
            if (!password || password.length < 6) return showWarning('密码至少6位');
            const tok = (adminTokenInput?.value || '').trim();
            if (!tok) return showWarning('请先填写管理员令牌');
            try {
              const res = await fetch('/api/admin/users', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-Admin-Token': tok
                },
                body: JSON.stringify({ name, email, phone, organization, password })
              });
              const data = await res.json();
              if (!res.ok) return showError('创建失败', data?.detail || res.status);
              showSuccess('用户创建成功！');
              closeModal(document.querySelector('.modal:last-of-type'));
              // 自动刷新用户列表
              setTimeout(() => {
                refreshBtn.click();
              }, 800);
            } catch (e) {
              showError('创建异常', e.toString());
            }
          };
        const toolbar = document.createElement('div');
        toolbar.style.cssText = `
          display: flex;
          gap: 12px;
          padding: 16px 24px;
          background: var(--gray-50);
          border-bottom: 1px solid var(--border);
          flex-wrap: wrap;
          align-items: center;
        `;
        
        // 搜索框
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.placeholder = '搜索用户 (邮箱、姓名、机构)';
        searchInput.style.cssText = `
          flex: 1;
          padding: 8px 12px;
          border: 1px solid var(--border);
          border-radius: 8px;
          font-size: 14px;
          background: white;
          min-width: 300px;
        `;
        
        const searchBtn = document.createElement('button');
  searchBtn.innerHTML = '🔍 搜索';
  searchBtn.className = 'btn secondary';
  searchBtn.style.whiteSpace = 'nowrap';
  searchBtn.style.fontWeight = '500';
  searchBtn.style.fontSize = '15px';
  searchBtn.style.padding = '8px 18px';
  searchBtn.style.borderRadius = '8px';
        
        const refreshBtn = document.createElement('button');
  refreshBtn.innerHTML = '🔄 刷新';
  refreshBtn.className = 'btn ghost';
  refreshBtn.style.whiteSpace = 'nowrap';
  refreshBtn.style.fontWeight = '500';
  refreshBtn.style.fontSize = '15px';
  refreshBtn.style.padding = '8px 18px';
  refreshBtn.style.borderRadius = '8px';
        
        const exportBtn = document.createElement('button');
  exportBtn.innerHTML = '📤 导出';
  exportBtn.className = 'btn ghost';
  exportBtn.style.whiteSpace = 'nowrap';
  exportBtn.style.fontWeight = '500';
  exportBtn.style.fontSize = '15px';
  exportBtn.style.padding = '8px 18px';
  exportBtn.style.borderRadius = '8px';
        
        toolbar.appendChild(searchInput);
  toolbar.appendChild(searchInput);
  toolbar.appendChild(searchInput);
  toolbar.appendChild(searchBtn);
  toolbar.appendChild(refreshBtn);
  toolbar.appendChild(addUserBtn);
  toolbar.appendChild(exportBtn);
        
        // 内容区域
        const content = document.createElement('div');
        content.style.cssText = `
          flex: 1;
          overflow-y: auto;
          padding: 0;
        `;
        
        // 创建用户管理表格
        const table = document.createElement('table');
        table.style.cssText = `
          width: 100%;
          border-collapse: collapse;
          font-size: 14px;
        `;
        
        // 表头
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr style="background: var(--gray-100); position: sticky; top: 0; z-index: 10;">
            <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">ID</th>
            <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">邮箱</th>
            <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">姓名</th>
            <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">机构</th>
            <th style="padding: 12px 16px; text-align: center; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">类型</th>
            <th style="padding: 12px 16px; text-align: right; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">配额</th>
            <th style="padding: 12px 16px; text-align: right; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">已用</th>
            <th style="padding: 12px 16px; text-align: center; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700);">状态</th>
            <th style="padding: 12px 16px; text-align: center; border-bottom: 2px solid var(--border); font-weight: 600; color: var(--gray-700); width: 140px;">操作</th>
          </tr>
        `;
        
        // 表体
        const tbody = document.createElement('tbody');
        
        function renderUsers(userList) {
          tbody.innerHTML = '';
          userList.forEach((user, index) => {
            const row = document.createElement('tr');
            row.style.cssText = `
              border-bottom: 1px solid var(--border);
              transition: background-color 0.2s ease;
            `;
            
            if (index % 2 === 1) {
              row.style.backgroundColor = 'var(--gray-25)';
            }
            
            row.addEventListener('mouseenter', () => {
              row.style.backgroundColor = 'var(--primary-50)';
            });
            row.addEventListener('mouseleave', () => {
              row.style.backgroundColor = index % 2 === 0 ? 'white' : 'var(--gray-25)';
            });
            
            const adminBadge = user.is_admin ? 
              '<span style="background: var(--error-100); color: var(--error-700); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">管理员</span>' : 
              '<span style="background: var(--gray-100); color: var(--gray-600); padding: 2px 8px; border-radius: 12px; font-size: 12px;">普通用户</span>';
            
            const statusBadge = (user.status === 'active' || !user.status) ?
              '<span style="background: var(--success-100); color: var(--success-700); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">活跃</span>' :
              '<span style="background: var(--warning-100); color: var(--warning-700); padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">禁用</span>';
            
            // 计算使用量状态和颜色
            const usageUsed = user.usage_used || 0;
            const usageQuota = user.usage_quota;
            let usageColor = 'var(--primary-600)';
            let usageStyle = 'font-weight: 600;';
            
            if (usageQuota !== null) {
              const usagePercent = (usageUsed / usageQuota) * 100;
              if (usagePercent >= 100) {
                usageColor = 'var(--error-600)';
                usageStyle += ' background: var(--error-50); padding: 2px 6px; border-radius: 4px;';
              } else if (usagePercent >= 80) {
                usageColor = 'var(--warning-600)';
                usageStyle += ' background: var(--warning-50); padding: 2px 6px; border-radius: 4px;';
              } else if (usagePercent >= 50) {
                usageColor = 'var(--primary-600)';
                usageStyle += ' background: var(--primary-50); padding: 2px 6px; border-radius: 4px;';
              }
            }
            
            // 添加实时更新标识
            const usageDisplay = usageUsed + (user._justUpdated ? ' ✨' : '');
            
            row.innerHTML = `
              <td style="padding: 12px 16px; font-weight: 600; color: var(--primary-600);">${user.id}</td>
              <td style="padding: 12px 16px; font-family: 'Courier New', monospace; color: var(--gray-700); max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${user.email}">${user.email || '-'}</td>
              <td style="padding: 12px 16px; color: var(--gray-700);">${user.name || '-'}</td>
              <td style="padding: 12px 16px; color: var(--gray-600); font-size: 13px; max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${user.organization}">${user.organization || '-'}</td>
              <td style="padding: 12px 16px; text-align: center;">${adminBadge}</td>
              <td style="padding: 12px 16px; text-align: right; font-weight: 600; color: var(--gray-700);">${usageQuota === null ? '无限制' : usageQuota}</td>
              <td style="padding: 12px 16px; text-align: right; color: ${usageColor}; ${usageStyle}" title="使用量: ${usageUsed}${usageQuota !== null ? ` / ${usageQuota} (${Math.round((usageUsed/usageQuota)*100)}%)` : ''}">${usageDisplay}</td>
              <td style="padding: 12px 16px; text-align: center;">${statusBadge}</td>
              <td style="padding: 12px 16px; text-align: center;">
                <div style="display: flex; gap: 4px; justify-content: center; flex-wrap: wrap;">
                  <button onclick="showUserDetailModal(${JSON.stringify(user).replace(/"/g, '&quot;')})" class="btn-icon" title="查看详情" style="padding: 4px 8px; font-size: 12px; min-width: 32px;">👁️</button>
                  <button onclick="showEditUserModal(${JSON.stringify(user).replace(/"/g, '&quot;')})" class="btn-icon" title="编辑用户" style="padding: 4px 8px; font-size: 12px; min-width: 32px;">✏️</button>
                  <button onclick="showQuotaModal(${JSON.stringify(user).replace(/"/g, '&quot;')})" class="btn-icon" title="设置配额" style="padding: 4px 8px; font-size: 12px; min-width: 32px;">⚙️</button>
                  <button onclick="resetUserUsage(${user.id}, '${(user.name || user.email).replace(/'/g, "\\'")}')" class="btn-icon" title="重置用量" style="padding: 4px 8px; font-size: 12px; min-width: 32px;">🔄</button>
                  <button onclick="confirmDeleteUser(${user.id}, '${(user.name || user.email).replace(/'/g, "\\'")}')" class="btn-icon" title="删除用户" style="padding: 4px 8px; font-size: 12px; min-width: 32px; background: var(--error-100); color: var(--error-700);">🗑️</button>
                </div>
              </td>
            `;
            
            tbody.appendChild(row);
          });
        }
        
        renderUsers(users);
        
        table.appendChild(thead);
        table.appendChild(tbody);
        content.appendChild(table);
        
        // 底部统计信息
        const footer = document.createElement('div');
        footer.style.cssText = `
          padding: 16px 24px;
          background: var(--gray-50);
          border-top: 1px solid var(--border);
          border-radius: 0 0 20px 20px;
          font-size: 13px;
          color: var(--gray-600);
        `;
        
        const adminCount = users.filter(u => u.is_admin).length;
        const activeCount = users.filter(u => u.status === 'active' || !u.status).length;
        
        footer.innerHTML = `
          📊 统计信息: 总用户 ${users.length} 位 | 管理员 ${adminCount} 位 | 活跃用户 ${activeCount} 位 | 
          <span style="color: var(--primary-600); font-weight: 600;">点击操作按钮管理用户</span>
        `;
        
        modalCard.appendChild(header);
        modalCard.appendChild(toolbar);
        modalCard.appendChild(content);
        modalCard.appendChild(footer);
        modal.appendChild(modalCard);
        
        // 搜索功能
        searchBtn.addEventListener('click', () => {
          const query = searchInput.value.toLowerCase().trim();
          if (!query) {
            renderUsers(users);
            return;
          }
          
          const filtered = users.filter(user => 
            user.email?.toLowerCase().includes(query) ||
            user.name?.toLowerCase().includes(query) ||
            user.organization?.toLowerCase().includes(query) ||
            user.id.toString().includes(query)
          );
          
          renderUsers(filtered);
        });
        
        searchInput.addEventListener('keyup', (e) => {
          if (e.key === 'Enter') {
            searchBtn.click();
          }
        });
        
        // 实时更新功能
        let realtimeUpdateInterval = null;
        let isRealtimeEnabled = false;
        
        // 刷新功能
        refreshBtn.addEventListener('click', async () => {
          const tok = (adminTokenInput?.value || '').trim();
          if (!tok) {
            showWarning('请先填写管理员令牌');
            return;
          }
          
          try {
            const res = await fetch('/api/admin/users', { headers: { 'X-Admin-Token': tok } });
            const data = await res.json();
            if (!res.ok) {
              showError('刷新失败', data?.detail || '服务器错误 ' + res.status);
              return;
            }
            
            users.splice(0, users.length, ...data);
            renderUsers(users);
            searchInput.value = '';
            showSuccess('用户列表已刷新');
          } catch (e) {
            showError('刷新异常', e.toString());
          }
        });
        
        // 实时更新开关
        const realtimeToggleBtn = document.createElement('button');
        realtimeToggleBtn.innerHTML = '🔄 实时更新';
        realtimeToggleBtn.className = 'btn-icon';
        realtimeToggleBtn.title = '开启/关闭实时更新用户使用统计';
        realtimeToggleBtn.style.cssText = `
          background: var(--primary-100);
          color: var(--primary-700);
          border: 1px solid var(--primary-200);
          padding: 8px 16px;
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
        `;
        
        realtimeToggleBtn.addEventListener('click', () => {
          if (isRealtimeEnabled) {
            // 关闭实时更新
            if (realtimeUpdateInterval) {
              clearInterval(realtimeUpdateInterval);
              realtimeUpdateInterval = null;
            }
            isRealtimeEnabled = false;
            realtimeToggleBtn.innerHTML = '🔄 实时更新';
            realtimeToggleBtn.style.background = 'var(--primary-100)';
            realtimeToggleBtn.style.color = 'var(--primary-700)';
            showInfo('实时更新已关闭');
          } else {
            // 开启实时更新
            const tok = (adminTokenInput?.value || '').trim();
            if (!tok) {
              showWarning('请先填写管理员令牌');
              return;
            }
            
            isRealtimeEnabled = true;
            realtimeToggleBtn.innerHTML = '⏸️ 停止更新';
            realtimeToggleBtn.style.background = 'var(--warning-100)';
            realtimeToggleBtn.style.color = 'var(--warning-700)';
            
            // 立即更新一次
            updateUserUsageStats(tok);
            
            // 设置定时器，每5秒更新一次
            realtimeUpdateInterval = setInterval(() => {
              updateUserUsageStats(tok);
            }, 5000);
            
            showSuccess('实时更新已开启，每5秒自动刷新使用统计');
          }
        });
        
        // 实时更新用户使用统计的函数
        async function updateUserUsageStats(token) {
          try {
            const res = await fetch('/api/admin/users', { headers: { 'X-Admin-Token': token } });
            const data = await res.json();
            if (!res.ok) {
              return; // 静默失败，不显示错误
            }
            
            let hasChanges = false;
            
            // 更新用户数据中的使用统计
            data.forEach(newUser => {
              const existingUser = users.find(user => user.id === newUser.id);
              if (existingUser) {
                // 检查是否有变化
                if (existingUser.usage_used !== newUser.usage_used || 
                    existingUser.daily_used !== newUser.daily_used) {
                  hasChanges = true;
                  existingUser._justUpdated = true; // 标记为刚更新
                  
                  // 2秒后移除更新标记
                  setTimeout(() => {
                    existingUser._justUpdated = false;
                    renderUsers(users);
                  }, 2000);
                }
                
                existingUser.usage_used = newUser.usage_used;
                existingUser.daily_used = newUser.daily_used;
                existingUser.usage_quota = newUser.usage_quota;
                existingUser.daily_quota = newUser.daily_quota;
              }
            });
            
            // 重新渲染用户列表
            renderUsers(users);
            
            // 如果有变化，显示提示
            if (hasChanges) {
              // 在工具栏显示更新提示
              const updateIndicator = modalCard.querySelector('.update-indicator');
              if (updateIndicator) {
                updateIndicator.style.display = 'inline-block';
                setTimeout(() => {
                  updateIndicator.style.display = 'none';
                }, 3000);
              }
            }
          } catch (e) {
            // 静默失败，不影响用户体验
          }
        }
        
        // 添加更新指示器
        const updateIndicator = document.createElement('span');
        updateIndicator.className = 'update-indicator';
        updateIndicator.innerHTML = '📊 数据已更新';
        updateIndicator.style.cssText = `
          display: none;
          background: var(--success-100);
          color: var(--success-700);
          padding: 4px 8px;
          border-radius: 4px;
          font-size: 12px;
          font-weight: 600;
          margin-left: 8px;
          animation: fadeInOut 3s ease-in-out;
        `;
        
        // 将实时更新按钮和指示器添加到工具栏
        const toolbarElement = modalCard.querySelector('.modal-header');
        if (toolbarElement) {
          toolbarElement.appendChild(realtimeToggleBtn);
          toolbarElement.appendChild(updateIndicator);
        }
        
        // 导出功能
        exportBtn.addEventListener('click', async () => {
          const tok = (adminTokenInput?.value || '').trim();
          if (!tok) {
            showWarning('请先填写管理员令牌');
            return;
          }
          
          try {
            const res = await fetch('/api/admin/users:export-csv', { headers: { 'X-Admin-Token': tok } });
            const text = await res.text();
            if (!res.ok) {
              showError('CSV导出失败', '服务器错误 ' + res.status);
              return;
            }
            
            const blob = new Blob([text], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'users.csv';
            a.click();
            showSuccess('CSV文件导出成功！');
          } catch (e) {
            showError('CSV导出异常', e.toString());
          }
        });
        
        // 点击背景关闭
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
          }
        });
        
        // ESC键关闭
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
        
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
        
        // 全局函数定义
        window.resetUserUsage = async (userId, userName) => {
          showConfirm(`确认重置用户 "${userName}" 的使用量？\n\n此操作将清空用户的使用记录，无法恢复`, async () => {
            const tok = (adminTokenInput?.value || '').trim();
            if (!tok) {
              showWarning('请先填写管理员令牌');
              return;
            }
            
            try {
              const res = await fetch(`/api/admin/users/${userId}:reset-usage`, {
                method: 'POST',
                headers: { 'X-Admin-Token': tok }
              });
              const data = await res.json();
              if (!res.ok) {
                showError('重置用量失败', data?.detail || '服务器错误 ' + res.status);
                return;
              }
              
              showSuccess('用户用量已重置', '用户的使用统计已清零');
              refreshBtn.click(); // 自动刷新列表
            } catch (e) {
              showError('重置用量异常', e.toString());
            }
          });
        };
        
        window.showQuotaModal = (user) => {
          const quotaModal = document.createElement('div');
          quotaModal.className = 'modal';
          quotaModal.style.display = 'flex';
          
          const quotaModalCard = document.createElement('div');
          quotaModalCard.className = 'modal-card';
          quotaModalCard.style.width = '500px';
          quotaModalCard.style.maxWidth = '95vw';
          
          quotaModalCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0; color: var(--primary-700);">⚙️ 设置用户配额</h3>
              <button onclick="document.body.removeChild(this.closest('.modal')); document.body.style.overflow = 'auto';" style="background: var(--error-50); color: var(--error-500); border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 18px; font-weight: bold; cursor: pointer;">×</button>
            </div>
            
            <div style="margin-bottom: 20px; padding: 16px; background: var(--primary-50); border-radius: 12px;">
              <div style="font-weight: 600; color: var(--primary-700); margin-bottom: 8px;">用户信息</div>
              <div style="font-size: 14px; color: var(--primary-600);">
                <div>ID: ${user.id} | 姓名: ${user.name || '-'} | 邮箱: ${user.email}</div>
                <div>当前配额: ${user.usage_quota === null ? '无限制' : user.usage_quota} | 已用: ${user.usage_used || 0}</div>
              </div>
            </div>
            
            <div style="display: grid; gap: 16px; margin-bottom: 24px;">
              <div class="form-field">
                <label>总使用配额</label>
                <input id="quotaInput" type="number" placeholder="留空表示无限制" value="${user.usage_quota || ''}" style="width: 100%;" />
                <div class="field-hint">设置用户的总使用次数限制，留空表示无限制</div>
              </div>
              
              <div class="form-field">
                <label>每日使用配额</label>
                <input id="dailyQuotaInput" type="number" placeholder="留空表示无限制" value="${user.daily_quota || ''}" style="width: 100%;" />
                <div class="field-hint">设置用户每日的使用次数限制，留空表示无限制</div>
              </div>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid var(--border);">
              <button onclick="document.body.removeChild(this.closest('.modal')); document.body.style.overflow = 'auto';" class="btn ghost">取消</button>
              <button onclick="saveQuotaSettings(${user.id})" class="btn primary">保存设置</button>
            </div>
          `;
          
          quotaModal.appendChild(quotaModalCard);
          
          // 点击背景关闭
          quotaModal.addEventListener('click', (e) => {
            if (e.target === quotaModal) {
              document.body.removeChild(quotaModal);
              document.body.style.overflow = 'auto';
            }
          });
          
          document.body.appendChild(quotaModal);
          document.body.style.overflow = 'hidden';
          
          // 保存配额函数
          window.saveQuotaSettings = async (userId) => {
            const tok = (adminTokenInput?.value || '').trim();
            if (!tok) {
              showWarning('请先填写管理员令牌');
              return;
            }
            
            const quota = document.getElementById('quotaInput').value.trim();
            const dailyQuota = document.getElementById('dailyQuotaInput').value.trim();
            const quotaValue = quota === '' ? null : Number(quota);
            const dailyQuotaValue = dailyQuota === '' ? null : Number(dailyQuota);
            
            try {
              const res = await fetch(`/api/admin/users/${userId}`, {
                method: 'PATCH',
                headers: { 'X-Admin-Token': tok, 'Content-Type': 'application/json' },
                body: JSON.stringify({ usage_quota: quotaValue, daily_quota: dailyQuotaValue })
              });
              const data = await res.json();
              if (!res.ok) {
                showError('配额设置失败', data?.detail || '服务器错误 ' + res.status);
                return;
              }
              
              showSuccess('配额设置成功！', data);
              document.body.removeChild(quotaModal);
              document.body.style.overflow = 'auto';
              
              // 触发刷新用户列表
              refreshBtn.click();
            } catch (e) {
              showError('配额设置异常', e.toString());
            }
          };
        };
        
        return modal;
      }

      // 显示用户详细信息弹窗
      function showUserDetailModal(user) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'flex';
        
        const modalCard = document.createElement('div');
        modalCard.className = 'modal-card';
        modalCard.style.width = '500px';
        modalCard.style.maxWidth = '95vw';
        
        modalCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: var(--primary-700);">👤 用户详细信息</h3>
            <button onclick="document.body.removeChild(this.closest('.modal')); document.body.style.overflow = 'auto';" style="background: var(--error-50); color: var(--error-500); border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 18px; font-weight: bold; cursor: pointer;">×</button>
          </div>
          
          <div style="display: grid; gap: 16px;">
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center;">
              <span style="font-weight: 600; color: var(--gray-700);">用户ID:</span>
              <span style="font-family: 'Courier New', monospace; background: var(--primary-50); padding: 4px 8px; border-radius: 6px; color: var(--primary-700);">${user.id}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center;">
              <span style="font-weight: 600; color: var(--gray-700);">邮箱地址:</span>
              <span style="font-family: 'Courier New', monospace;">${user.email || '-'}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center;">
              <span style="font-weight: 600; color: var(--gray-700);">用户姓名:</span>
              <span>${user.name || '-'}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center;">
              <span style="font-weight: 600; color: var(--gray-700);">所属机构:</span>
              <span>${user.organization || '-'}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center;">
              <span style="font-weight: 600; color: var(--gray-700);">联系电话:</span>
              <span>${user.phone || '-'}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center;">
              <span style="font-weight: 600; color: var(--gray-700);">账户类型:</span>
              <span>${user.is_admin ? '<span style="background: var(--error-100); color: var(--error-700); padding: 4px 12px; border-radius: 12px; font-weight: 600;">管理员</span>' : '<span style="background: var(--gray-100); color: var(--gray-600); padding: 4px 12px; border-radius: 12px;">普通用户</span>'}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center;">
              <span style="font-weight: 600; color: var(--gray-700);">账户状态:</span>
              <span>${(user.status === 'active' || !user.status) ? '<span style="background: var(--success-100); color: var(--success-700); padding: 4px 12px; border-radius: 12px; font-weight: 600;">活跃</span>' : '<span style="background: var(--warning-100); color: var(--warning-700); padding: 4px 12px; border-radius: 12px; font-weight: 600;">禁用</span>'}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center;">
              <span style="font-weight: 600; color: var(--gray-700);">使用配额:</span>
              <span style="font-weight: 600; color: var(--primary-600);">${user.usage_quota === null ? '无限制' : user.usage_quota}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center;">
              <span style="font-weight: 600; color: var(--gray-700);">已使用量:</span>
              <span style="font-weight: 600; color: var(--success-600);">${user.usage_used || 0}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center;">
              <span style="font-weight: 600; color: var(--gray-700);">日配额:</span>
              <span style="font-weight: 600; color: var(--primary-600);">${user.daily_quota === null ? '无限制' : (user.daily_quota || '-')}</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: center;">
              <span style="font-weight: 600; color: var(--gray-700);">今日已用:</span>
              <span style="font-weight: 600; color: var(--success-600);">${user.daily_used || 0}</span>
            </div>
            
            ${user.notes ? `
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 12px; align-items: start;">
              <span style="font-weight: 600; color: var(--gray-700);">备注信息:</span>
              <span style="background: var(--gray-50); padding: 8px 12px; border-radius: 8px; color: var(--gray-700);">${user.notes}</span>
            </div>
            ` : ''}
          </div>
          
          <div style="margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border); text-align: center;">
            <button onclick="document.body.removeChild(this.closest('.modal')); document.body.style.overflow = 'auto';" class="btn ghost">关闭</button>
          </div>
        `;
        
        modal.appendChild(modalCard);
        
        // 点击背景关闭
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
            document.body.style.overflow = 'auto';
          }
        });
        
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';
      }

    </script>
  </body>
  </html>




